<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê√≥ng H·ª•i - Qu·∫£n L√Ω H·ª•i</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
    :root {
        --primary-color: #3498db;
        --secondary-color: #2c3e50;
        --accent-color: #e74c3c;
        --light-color: #ecf0f1;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        color: #333;
        padding: 20px;
    }
    
    .header {
        background-color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    
    .card-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: 10px 10px 0 0 !important;
        padding: 15px 20px;
        font-weight: 600;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border: none;
    }
    
    .btn-primary:hover {
        background-color: #2980b9;
    }
    
    .btn-success {
        background-color: var(--success-color);
        border: none;
    }

    .btn-zalo {
        background-color: #0068ff;
        color: white;
        border: none;
    }
    
    .btn-zalo:hover {
        background-color: #0051cc;
        color: white;
    }
    
    .back-btn {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 20px;
        display: inline-block;
    }
    
    .back-btn:hover {
        text-decoration: underline;
    }
    
    .member-table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .member-table th {
        background-color: var(--secondary-color);
        color: white;
        padding: 12px 15px;
        text-align: center;
        font-weight: 600;
        position: sticky;
        top: 0;
    }
    
    .member-table td {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        text-align: center;
        vertical-align: middle;
    }
    
    .member-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .member-table tr:hover {
        background-color: #e9ecef;
    }
    
    .paid {
        background-color: #d4edda !important;
        color: #155724;
    }
    
    .not-paid {
        background-color: #f8d7da !important;
        color: #721c24;
    }
    
    /* CSS FIXED cho ng∆∞·ªùi h·ªët - ƒê·∫∂T ·ªû ƒê√ÇY ƒê·ªÇ C√ì ƒê·ªò ∆ØU TI√äN CAO */
    .member-table tr.hot-person {
        background: linear-gradient(135deg, #c8f7c5 0%, #87d18d 100%) !important;
        color: #145214 !important;
        font-weight: 600;
        border-left: 4px solid #27ae60;
    }
    
    .member-table tr.hot-person td {
        background: transparent !important;
        border-color: #27ae60 !important;
    }
    
    .member-table tr.already-hot {
        background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%) !important;
        color: #636e72 !important;
        border-left: 4px solid #636e72;
    }
    
    .member-table tr.already-hot td {
        background: transparent !important;
        border-color: #b2bec3 !important;
    }
    
    /* ƒê·∫£m b·∫£o ghi ƒë√® t·∫•t c·∫£ c√°c tr·∫°ng th√°i kh√°c */
    .member-table tr.hot-person.paid,
    .member-table tr.hot-person.not-paid,
    .member-table tr.already-hot.paid,
    .member-table tr.already-hot.not-paid {
        background: inherit !important;
    }
    
    .member-table tr.hot-person:hover,
    .member-table tr.already-hot:hover {
        opacity: 0.9;
    }
    
    .member-table tr.hot-person:nth-child(even),
    .member-table tr.already-hot:nth-child(even),
    .member-table tr.hot-person:nth-child(odd),
    .member-table tr.already-hot:nth-child(odd) {
        background: inherit !important;
    }
    
    .badge {
        font-size: 0.7em;
        margin-left: 5px;
    }
    
    .period-selector {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .hot-info-badge {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .share-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        border-left: 4px solid #0068ff;
    }

    .no-actions {
        color: #6c757d;
        font-style: italic;
    }
    
    .member-table th:nth-child(3),
    .member-table td:nth-child(3) {
        width: 150px;
    }

    .phone-column {
        direction: ltr;
        text-align: center;
    }

    .zalo-chat-btn {
        display: inline-block;
        padding: 6px 12px;
        background: #0068FF;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.8em;
        margin-top: 4px;
    }

    .zalo-chat-btn:hover {
        background: #0051cc;
        color: white;
        text-decoration: none;
    }

    /* Responsive cho mobile */
    @media (max-width: 768px) {
        .member-table th:nth-child(3),
        .member-table td:nth-child(3) {
            width: 120px;
        }
        
        .phone-column {
            font-size: 0.8em;
        }
        
        .zalo-chat-btn {
            padding: 4px 8px;
            font-size: 0.7em;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 3px;
        }
        
        .action-buttons .btn {
            font-size: 0.7em;
            padding: 0.2rem 0.4rem;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <a href="dayhui.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i Danh s√°ch d√¢y h·ª•i
        </a>
        
        <div class="header">
            <h2><i class="fas fa-money-bill-wave"></i> ƒê√≥ng H·ª•i</h2>
            <div>
                <span class="me-3">Xin ch√†o, <span id="userEmail"></span></span>
                <button class="btn btn-outline-secondary" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>

        <!-- Th√¥ng tin d√¢y h·ª•i -->
        <div class="summary-card">
            <div class="row">
                <div class="col-md-6">
                    <h4 id="huiNameDisplay">[T√™n d√¢y h·ª•i]</h4>
                    <p class="mb-1">Ti·ªÅn h·ª•i: <strong id="tienHuiDisplay">0ƒë</strong></p>
                    <p class="mb-1">Ti·ªÅn th·∫£o: <strong id="tienThaoDisplay">0ƒë</strong></p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1">K·ª≥ hi·ªán t·∫°i: <strong id="kyHienTaiDisplay">0</strong>/<span id="tongSoKyDisplay">0</span></p>
                    <p class="mb-1">S·ªë h·ªôi vi√™n: <strong id="soHoiVienDisplay">0</strong></p>
                    <p class="mb-0">Tr·∫°ng th√°i: <strong id="trangThaiDisplay">-</strong></p>
                </div>
            </div>
        </div>

        <!-- Ch·ªçn k·ª≥ ƒë√≥ng h·ª•i -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-alt"></i> Ch·ªçn k·ª≥ ƒë√≥ng h·ª•i
            </div>
            <div class="card-body">
                <div class="period-selector">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label"><strong>K·ª≥ ƒë√≥ng h·ª•i:</strong></label>
                            <select class="form-select" id="kyDongHui" onchange="loadMemberPaymentStatus()">
                                <option value="">Ch·ªçn k·ª≥...</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i> 
                                <span id="kyInfoText">Vui l√≤ng ch·ªçn k·ª≥ ƒë·ªÉ xem danh s√°ch h·ªôi vi√™n c·∫ßn ƒë√≥ng</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ph·∫ßn chia s·∫ª qua Zalo -->
                <div id="shareSection" class="share-section" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6><i class="fas fa-share-alt"></i> Chia s·∫ª th√¥ng tin ƒë√≥ng h·ª•i</h6>
                            <p class="mb-1" id="shareInfoText">Th√¥ng tin k·ª≥ ƒë√≥ng, ng√†y ƒë√≥ng v√† s·ªë ti·ªÅn</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-zalo" onclick="copyShareInfo()">
                                <i class="fab fa-zalo"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh s√°ch h·ªôi vi√™n -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-users"></i> Danh s√°ch h·ªôi vi√™n c·∫ßn ƒë√≥ng k·ª≥ <span id="currentPeriodDisplay">-</span>
                <span id="hotPersonInfo" class="hot-info-badge ms-2" style="display: none;"></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="member-table">
                        <thead>
                            <tr>
                                <th width="50">STT</th>
                                <th>H·ªôi vi√™n</th>
                                <th width="150">S·ªë ƒëi·ªán tho·∫°i</th>
                                <th width="120">S·ªë ch√¢n</th>
                                <th width="150">Tr·∫°ng th√°i</th>
                                <th width="150">S·ªë ti·ªÅn ph·∫£i ƒë√≥ng</th>
                                <th width="200">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 text-end">
                    <button class="btn btn-success" onclick="markAllAsPaid()" id="markAllBtn" style="display: none;">
                        <i class="fas fa-check-double"></i> ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë√≥ng
                    </button>
                </div> 
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYV8na-Az2LAgpl6QM2Tiwr6Gm9yhXQZ0",
            authDomain: "quan-ly-hui-8ad1c.firebaseapp.com",
            databaseURL: "https://quan-ly-hui-8ad1c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quan-ly-hui-8ad1c",
            storageBucket: "quan-ly-hui-8ad1c.firebasestorage.app",
            messagingSenderId: "665511229865",
            appId: "1:665511229865:web:fe44f814fff618e35e6cb8"
        };

        let database;
        let auth;
        let currentUser = null;
        let currentHui = null;
        let currentHuiId = null;
        let currentPeriod = null;
        let currentHotPerson = null;
        let currentHotPersonId = null; // <-- Th√™m bi·∫øn n√†y
        let currentThamKeu = 0;

        // Kh·ªüi t·∫°o Firebase
        function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK ch∆∞a ƒë∆∞·ª£c t·∫£i');
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                auth = firebase.auth();
                console.log('‚úÖ Firebase ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng');
                return true;
            } catch (error) {
                console.error('‚ùå L·ªói kh·ªüi t·∫°o Firebase:', error);
                return false;
            }
        }

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('‚úÖ Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p:', user.uid, user.email);
                    document.getElementById('userEmail').textContent = user.email;
                    loadHuiData();
                } else {
                    currentUser = null;
                    window.location.href = 'dayhui.html';
                }
            });
        }

        // Copy th√¥ng tin chia s·∫ª
function copyShareInfo() {
    const shareText = document.getElementById('shareInfoText').textContent;
    
    // T·∫°o m·ªôt textarea t·∫°m th·ªùi ƒë·ªÉ copy
    const textarea = document.createElement('textarea');
    textarea.value = shareText;
    document.body.appendChild(textarea);
    textarea.select();
    textarea.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            alert('‚úÖ ƒê√£ copy th√¥ng b√°o ƒë√≥ng h·ª•i! B·∫°n c√≥ th·ªÉ d√°n v√†o Zalo ho·∫∑c c√°c ·ª©ng d·ª•ng nh·∫Øn tin kh√°c.');
        } else {
            alert('‚ùå Kh√¥ng th·ªÉ copy th√¥ng b√°o. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    } catch (err) {
        document.body.removeChild(textarea);
        alert('‚ùå L·ªói khi copy: ' + err);
    }
}

        // L·∫•y d·ªØ li·ªáu d√¢y h·ª•i t·ª´ URL parameter
        function getHuiIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('huiId');
        }

        // T·∫£i d·ªØ li·ªáu d√¢y h·ª•i
        async function loadHuiData() {
            const huiId = getHuiIdFromURL();
            if (!huiId) {
                alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin d√¢y h·ª•i');
                window.location.href = 'dayhui.html';
                return;
            }

            currentHuiId = huiId;

            try {
                const huiRef = database.ref('users/' + currentUser.uid + '/dayhui/' + huiId);
                const snapshot = await huiRef.once('value');
                
                if (!snapshot.exists()) {
                    alert('D√¢y h·ª•i kh√¥ng t·ªìn t·∫°i');
                    window.location.href = 'dayhui.html';
                    return;
                }

                currentHui = snapshot.val();
                displayHuiInfo();
                loadPeriodSelector();
                
            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu d√¢y h·ª•i:', error);
                alert('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
            }
        }

        // Hi·ªÉn th·ªã th√¥ng tin d√¢y h·ª•i
        function displayHuiInfo() {
            if (!currentHui) return;

            document.getElementById('huiNameDisplay').textContent = currentHui.tendayhui || 'Ch∆∞a c√≥ t√™n';
            document.getElementById('tienHuiDisplay').textContent = formatCurrency(currentHui.tienHui || 0);
            document.getElementById('tienThaoDisplay').textContent = formatCurrency(currentHui.tienThao || 0);
            document.getElementById('kyHienTaiDisplay').textContent = currentHui.soKy || 0;
            document.getElementById('tongSoKyDisplay').textContent = currentHui.tongSoKy || 0;
            
            // T√≠nh s·ªë h·ªôi vi√™n th·ª±c t·∫ø
            const soHoiVien = getHoiVienArray().length;
            document.getElementById('soHoiVienDisplay').textContent = soHoiVien;
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i
            const soKyDaHot = currentHui.soKy || 0;
            const tongSoKy = currentHui.tongSoKy || 0;
            let trangThai = '';
            
            if (soKyDaHot === 0) {
                trangThai = 'Ch·ªù b·∫Øt ƒë·∫ßu';
            } else if (soKyDaHot > 0 && soKyDaHot < tongSoKy) {
                trangThai = 'ƒêang ho·∫°t ƒë·ªông';
            } else if (soKyDaHot === tongSoKy) {
                trangThai = 'ƒê√£ k·∫øt th√∫c';
            } else {
                trangThai = currentHui.trangThai || 'Kh√¥ng x√°c ƒë·ªãnh';
            }
            
            document.getElementById('trangThaiDisplay').textContent = trangThai;
        }

        // T·∫£i danh s√°ch k·ª≥ v√†o selector
        function loadPeriodSelector() {
            const periodSelect = document.getElementById('kyDongHui');
            periodSelect.innerHTML = '<option value="">Ch·ªçn k·ª≥...</option>';
            
            const tongSoKy = currentHui.tongSoKy || 0;
            const soKyDaHot = currentHui.soKy || 0;
            
            // Ch·ªâ hi·ªÉn th·ªã c√°c k·ª≥ t·ª´ 1 ƒë·∫øn k·ª≥ hi·ªán t·∫°i + 1 (n·∫øu ch∆∞a k·∫øt th√∫c)
            const kyToiDa = tongSoKy;
            
            for (let i = 1; i <= kyToiDa; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `K·ª≥ ${i}`;
                
                if (i <= soKyDaHot) {
                    option.textContent += ' (ƒê√£ h·ªët)';
                } else if (i === soKyDaHot + 1) {
                    option.textContent += ' (K·ª≥ hi·ªán t·∫°i)';
                }
                
                periodSelect.appendChild(option);
            }
        }

        // T·∫£i tr·∫°ng th√°i ƒë√≥ng ti·ªÅn c·ªßa h·ªôi vi√™n
        async function loadMemberPaymentStatus() {
            const periodSelect = document.getElementById('kyDongHui');
    currentPeriod = parseInt(periodSelect.value);
    
    if (!currentPeriod || currentPeriod < 1) {
        document.getElementById('memberTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                    Vui l√≤ng ch·ªçn k·ª≥ ƒë√≥ng h·ª•i
                </td>
            </tr>
        `;
        document.getElementById('markAllBtn').style.display = 'none';
        document.getElementById('shareSection').style.display = 'none';
        document.getElementById('hotPersonInfo').style.display = 'none';
        return;
    }

    document.getElementById('currentPeriodDisplay').textContent = currentPeriod;
    
    // Reset th√¥ng tin ng∆∞·ªùi h·ªët
    currentHotPerson = null;
currentHotPersonId = null; // <-- Reset c·∫£ ID
currentThamKeu = 0;

try {
    // L·∫•y th√¥ng tin h·ªët h·ª•i cho k·ª≥ n√†y
    const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot/${currentPeriod}`);
    const hotSnap = await hotRef.once('value');

    if (hotSnap.exists()) {
        const hotData = hotSnap.val();
        currentThamKeu = hotData.thamKeu || 0;

        // T√¨m th√¥ng tin ng∆∞·ªùi h·ªët (∆ØU TI√äN ID)
        if (hotData.nguoiHot) { // 'nguoiHot' l√† ID
            currentHotPersonId = hotData.nguoiHot; // <-- L∆∞u ID

            if (hotData.nguoiHotTen) {
                currentHotPerson = hotData.nguoiHotTen; // L·∫•y t√™n n·∫øu c√≥
            } else {
                // N·∫øu kh√¥ng c√≥ t√™n, t√¨m t√™n t·ª´ ID
                const hoiVienArray = getHoiVienArray();
                const nguoiHot = hoiVienArray.find(hv => hv.id === currentHotPersonId);
                if (nguoiHot) {
                    currentHotPerson = nguoiHot.ten;
                } else {
                    currentHotPerson = "(Kh√¥ng t√¨m th·∫•y t√™n)";
                }
            }
        } else if (hotData.nguoiHotTen) { 
            // Fallback: N·∫øu ch·ªâ c√≥ t√™n, kh√¥ng c√≥ ID (d·ªØ li·ªáu c≈©)
            currentHotPerson = hotData.nguoiHotTen;
            const hoiVienArray = getHoiVienArray();
            const nguoiHot = hoiVienArray.find(hv => hv.ten === currentHotPerson);
            if (nguoiHot) {
                currentHotPersonId = nguoiHot.id; // C·ªë g·∫Øng t√¨m ID t·ª´ t√™n
            }
        }
    }

        // Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi h·ªët
        if (currentHotPerson) {
            document.getElementById('hotPersonInfo').style.display = 'inline-block';
            document.getElementById('hotPersonInfo').textContent = `Ng∆∞·ªùi h·ªët: ${currentHotPerson} - ThƒÉm k√™u: ${formatCurrency(currentThamKeu)}`;
        } else {
            document.getElementById('hotPersonInfo').style.display = 'none';
        }

        // Hi·ªÉn th·ªã th√¥ng tin k·ª≥
        const soKyDaHot = currentHui.soKy || 0;
        let kyInfo = '';
        
        if (currentPeriod <= soKyDaHot) {
            kyInfo = `K·ª≥ ${currentPeriod} ƒë√£ ƒë∆∞·ª£c h·ªët. Hi·ªÉn th·ªã danh s√°ch ƒë√≥ng ti·ªÅn cho k·ª≥ n√†y.`;
            if (currentHotPerson) {
                kyInfo += ` Ng∆∞·ªùi h·ªët: ${currentHotPerson}`;
            }
        } else if (currentPeriod === soKyDaHot + 1) {
            kyInfo = `K·ª≥ ${currentPeriod} l√† k·ª≥ hi·ªán t·∫°i c·∫ßn ƒë√≥ng ti·ªÅn.`;
        } else {
            kyInfo = `K·ª≥ ${currentPeriod} l√† k·ª≥ trong t∆∞∆°ng lai.`;
        }
        
        document.getElementById('kyInfoText').textContent = kyInfo;

        // Hi·ªÉn th·ªã ph·∫ßn chia s·∫ª
        document.getElementById('shareSection').style.display = 'block';
        updateShareInfo();

        const hoiVienArray = getHoiVienArray();
        const tableBody = document.getElementById('memberTableBody');
        
        if (hoiVienArray.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        Kh√¥ng c√≥ h·ªôi vi√™n n√†o trong d√¢y h·ª•i n√†y
                    </td>
                </tr>
            `;
            document.getElementById('markAllBtn').style.display = 'none';
            return;
        }

        let html = '';
        let allPaid = true;
        let hasMembersToPay = false;

        hoiVienArray.forEach((hoiVien, index) => {
    // L·∫•y s·ªë ƒëi·ªán tho·∫°i t·ª´ d·ªØ li·ªáu h·ªôi vi√™n
    const soDienThoai = hoiVien.soDienThoai || hoiVien.phone || '';
        
            // DEBUG tr∆∞·ªõc
        console.log('=== DEBUG HOT PERSON ===');
        console.log('Current Hot Person ID:', currentHotPersonId);
        console.log('Current Hot Person Name:', currentHotPerson);
        console.log('Current HoiVien ID:', hoiVien.id);
        console.log('Current HoiVien Name:', hoiVien.ten);

    // Ki·ªÉm tra xem h·ªôi vi√™n c√≥ ph·∫£i l√† ng∆∞·ªùi h·ªët k·ª≥ n√†y kh√¥ng
    const isHotPerson = (() => {
    if (!currentHotPersonId && !currentHotPerson) return false;

    // L·∫•y ph·∫ßn tr∆∞·ªõc d·∫•u "_" (ƒë·ªÉ so ID)
    const hotIdPrefix = (currentHotPersonId || '').split('_')[0];
    const memberIdPrefix = (hoiVien.id || '').split('_')[0];

    // Chu·∫©n h√≥a t√™n b·ªè ph·∫ßn "(Ch√¢n ...)"
    const normalizeName = (name) => name
        ? name.toLowerCase().replace(/\(.*?\)/g, '').trim()
        : '';

    return (
        memberIdPrefix === hotIdPrefix || // so kh·ªõp ID
        normalizeName(hoiVien.ten) === normalizeName(currentHotPerson) // so kh·ªõp t√™n
    );
})();

console.log('Is Hot Person:', isHotPerson);
    
    if (isHotPerson) {
        // Ng∆∞·ªùi h·ªët k·ª≥ n√†y - T√î M√ÄU TO√ÄN B·ªò D√íNG
        html += `
            <tr class="hot-person">
                <td>${index + 1}</td>
                <td class="text-start">
                    <strong>${hoiVien.ten}</strong>
                    <span class="badge bg-danger">ƒê√É H·ªêT K·ª≤ ${currentPeriod}</span>
                </td>
                <td class="phone-column">
                    ${soDienThoai ? `
                        <div>${soDienThoai}</div>
                        <a href="https://zalo.me/${soDienThoai}" class="zalo-chat-btn" target="_blank">
                            üí¨ Chat Zalo
                        </a>
                    ` : '<span class="text-muted">-</span>'}
                </td>
                <td>${hoiVien.soChan || 1}</td>
                <td>
                    <span class="badge bg-warning">ƒê√£ h·ªët</span>
                </td>
                <td>
                    <strong>${formatCurrency(0)}</strong>
                    <br>
                    <small class="text-muted">Kh√¥ng ph·∫£i ƒë√≥ng</small>
                </td>
                <td class="no-actions">
                    Kh√¥ng c·∫ßn thao t√°c
                </td>
            </tr>
        `;
        return;
    }

    // Ki·ªÉm tra xem h·ªôi vi√™n ƒë√£ h·ªët ·ªü k·ª≥ tr∆∞·ªõc ch∆∞a
    const daHotTruoc = hoiVien.daHot && hoiVien.kyDaHot < currentPeriod;
    
    if (daHotTruoc) {
        // ƒê√£ h·ªët tr∆∞·ªõc ƒë√≥ - T√î M√ÄU TO√ÄN B·ªò D√íNG
        html += `
            <tr class="already-hot">
                <td>${index + 1}</td>
                <td class="text-start">
                    <strong>${hoiVien.ten}</strong>
                    <span class="badge bg-secondary">ƒê√£ h·ªët k·ª≥ ${hoiVien.kyDaHot}</span>
                </td>
                <td class="phone-column">
                    ${soDienThoai ? `
                        <div>${soDienThoai}</div>
                        <a href="https://zalo.me/${soDienThoai}" class="zalo-chat-btn" target="_blank">
                            üí¨ Chat Zalo
                        </a>
                    ` : '<span class="text-muted">-</span>'}
                </td>
                <td>${hoiVien.soChan || 1}</td>
                <td>
                    <span class="badge bg-secondary">ƒê√£ h·ªët</span>
                </td>
                <td>
                    <strong>${formatCurrency(currentHui.tienHui || 0)}</strong>
                    <br>
                    <small class="text-muted">Ti·ªÅn h·ª•i ƒë·ªß</small>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-success" onclick="markAsPaid('${hoiVien.id}')">
                            <i class="fas fa-check"></i> ƒê√£ ƒë√≥ng
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="markAsUnpaid('${hoiVien.id}')">
                            <i class="fas fa-times"></i> H·ªßy
                        </button>
                        <button class="btn btn-sm btn-zalo" onclick="shareMemberPayment('${hoiVien.id}', '${hoiVien.ten}', ${currentHui.tienHui || 0}, '${soDienThoai}')">
                            <i class="fab fa-zalo"></i> Zalo
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

            hasMembersToPay = true;
            
            // Ki·ªÉm tra ƒë√£ ƒë√≥ng ti·ªÅn ch∆∞a
            const daDong = hoiVien.daDong && hoiVien.daDong[currentPeriod];
            
            if (!daDong) {
                allPaid = false;
            }

            // T√≠nh s·ªë ti·ªÅn ph·∫£i ƒë√≥ng
            let soTienPhaiDong = currentHui.tienHui || 0;
            if (currentPeriod <= soKyDaHot) {
                // N·∫øu k·ª≥ ƒë√£ h·ªët th√¨ tr·ª´ thƒÉm k√™u
                soTienPhaiDong -= currentThamKeu;
            }

            const rowClass = daDong ? 'paid' : 'not-paid';
            const statusText = daDong ? 'ƒê√£ ƒë√≥ng' : 'Ch∆∞a ƒë√≥ng';
            const statusBadge = daDong ? 'success' : 'danger';

            html += `
                <tr class="${rowClass}">
                    <td>${index + 1}</td>
                    <td class="text-start">
                        <strong>${hoiVien.ten}</strong>
                    </td>
                    <td class="phone-column">
                        ${soDienThoai ? `
                            <div>${soDienThoai}</div>
                            <a href="https://zalo.me/${soDienThoai}" class="zalo-chat-btn" target="_blank">
                                üí¨ Chat Zalo
                            </a>
                        ` : '<span class="text-muted">-</span>'}
                    </td>
                    <td>${hoiVien.soChan || 1}</td>
                    <td>
                        <span class="badge bg-${statusBadge}">${statusText}</span>
                    </td>
                    <td>
                        <strong>${formatCurrency(soTienPhaiDong)}</strong>
                        ${currentThamKeu > 0 ? `<br><small class="text-muted">(H·ª•i ${formatCurrency(currentHui.tienHui || 0)} - ThƒÉm k√™u ${formatCurrency(currentThamKeu)})</small>` : ''}
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${!daDong ? `
                                <button class="btn btn-sm btn-success" onclick="markAsPaid('${hoiVien.id}')">
                                    <i class="fas fa-check"></i> ƒê√°nh d·∫•u ƒë√£ ƒë√≥ng
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-secondary" onclick="markAsUnpaid('${hoiVien.id}')">
                                    <i class="fas fa-times"></i> H·ªßy ƒë√≥ng
                                </button>
                            `}
                            
                        </div>
                    </td>
                </tr>
            `;
        });

        if (!hasMembersToPay) {
            html = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        T·∫•t c·∫£ h·ªôi vi√™n ƒë√£ h·ªët ho·∫∑c kh√¥ng c·∫ßn ƒë√≥ng ti·ªÅn cho k·ª≥ n√†y
                    </td>
                </tr>
            `;
        }

        tableBody.innerHTML = html;
        
        // Hi·ªÉn th·ªã n√∫t "ƒê√°nh d·∫•u t·∫•t c·∫£" n·∫øu c√≥ th√†nh vi√™n ch∆∞a ƒë√≥ng
        if (hasMembersToPay && !allPaid) {
            document.getElementById('markAllBtn').style.display = 'block';
        } else {
            document.getElementById('markAllBtn').style.display = 'none';
        }

    } catch (error) {
        console.error('‚ùå L·ªói khi t·∫£i tr·∫°ng th√°i ƒë√≥ng ti·ªÅn:', error);
        document.getElementById('memberTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}
                </td>
            </tr>
        `;
    }
}

        // C·∫≠p nh·∫≠t th√¥ng tin chia s·∫ª
        function updateShareInfo() {
            const soKyDaHot = currentHui.soKy || 0;
    const today = new Date().toLocaleDateString('vi-VN');
    
    let shareText = `TH√îNG B√ÅO ƒê√ìNG H·ª§I\n`;
    shareText += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
    shareText += `D√¢y h·ª•i: ${currentHui.tendayhui || 'Ch∆∞a ƒë·∫∑t t√™n'}\n`;
    shareText += `K·ª≥: ${currentPeriod}\n`;
    shareText += `Ng√†y ƒë√≥ng: ${today}\n\n`;
    
    if (currentPeriod <= soKyDaHot) {
        shareText += `üí∞ TH√îNG TIN TI·ªÄN H·ª§I:\n`;
        shareText += `‚Ä¢ Ti·ªÅn h·ª•i: ${formatCurrency(currentHui.tienHui || 0)}\n`;
        if (currentThamKeu > 0) {
            shareText += `‚Ä¢ ThƒÉm k√™u: ${formatCurrency(currentThamKeu)}\n`;
            shareText += `‚Ä¢ Th·ª±c ƒë√≥ng: ${formatCurrency((currentHui.tienHui || 0) - currentThamKeu)}\n`;
        }
        if (currentHotPerson) {
            shareText += `‚Ä¢ Ng∆∞·ªùi h·ªët: ${currentHotPerson}\n`;
        }
    } else {
        shareText += `üí∞ S·ªê TI·ªÄN: ${formatCurrency(currentHui.tienHui || 0)}\n`;
    }
    
    shareText += `\nüìã L∆ØU √ù:\n`;
    shareText += `‚Ä¢ Vui l√≤ng ƒë√≥ng ti·ªÅn ƒë√∫ng h·∫°n\n`;
    shareText += `‚Ä¢ C√≥ th·ªÉ chuy·ªÉn kho·∫£n ho·∫∑c ti·ªÅn m·∫∑t\n`;
    shareText += `‚Ä¢ Li√™n h·ªá n·∫øu c√≥ th·∫Øc m·∫Øc`;
    
    document.getElementById('shareInfoText').textContent = shareText;
}

        // Chia s·∫ª qua Zalo
        function shareViaZalo() {
            const shareText = document.getElementById('shareInfoText').textContent;
    const encodedText = encodeURIComponent(shareText);
    
    // M·ªü Zalo v·ªõi tin nh·∫Øn ƒë√£ so·∫°n s·∫µn, ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ªçn ng∆∞·ªùi nh·∫≠n
    const zaloUrl = `https://zalo.me/?msg=${encodedText}`;
    window.open(zaloUrl, '_blank');
}

        // H√†m l·∫•y s·ªë ƒëi·ªán tho·∫°i t·ª´ t√™n h·ªôi vi√™n (t√¨m trong danh s√°ch ƒë√£ l∆∞u)
function getPhoneNumberFromMemberName(memberName) {
    // T√¨m trong danh s√°ch h·ªôi vi√™n hi·ªán t·∫°i c·ªßa d√¢y h·ª•i
    const hoiVienArray = getHoiVienArray();
    const hoiVien = hoiVienArray.find(hv => hv.ten === memberName);
    
    if (hoiVien && (hoiVien.soDienThoai || hoiVien.phone)) {
        return hoiVien.soDienThoai || hoiVien.phone;
    }
    
    return '';
}

        // Chia s·∫ª th√¥ng tin ƒë√≥ng ti·ªÅn c·ªßa t·ª´ng h·ªôi vi√™n qua Zalo
        function shareMemberPayment(hoiVienId, tenHoiVien, soTien, soDienThoai) {
    const today = new Date().toLocaleDateString('vi-VN');
    const soKyDaHot = currentHui.soKy || 0;
    
    let shareText = `Th√¥ng b√°o ƒë√≥ng h·ª•i\n`;
    shareText += `D√¢y h·ª•i: ${currentHui.tendayhui || 'Ch∆∞a ƒë·∫∑t t√™n'}\n`;
    shareText += `K·ª≥: ${currentPeriod}\n`;
    shareText += `H·ªôi vi√™n: ${tenHoiVien}\n`;
    
    if (currentPeriod <= soKyDaHot && currentThamKeu > 0) {
        shareText += `Ti·ªÅn h·ª•i: ${formatCurrency(currentHui.tienHui || 0)}\n`;
        shareText += `Ti·ªÅn th·∫£o: ${formatCurrency(currentThamKeu)}\n`;
        shareText += `S·ªë ti·ªÅn c·∫ßn ƒë√≥ng: ${formatCurrency(soTien)}\n`;
    } else {
        shareText += `S·ªë ti·ªÅn: ${formatCurrency(soTien)}\n`;
    }
    
    shareText += `Ng√†y ƒë√≥ng: ${today}\n`;
    shareText += `H√¨nh th·ª©c: Chuy·ªÉn kho·∫£n/Ti·ªÅn m·∫∑t`;
    
    // N·∫øu c√≥ s·ªë ƒëi·ªán tho·∫°i, m·ªü Zalo chat tr·ª±c ti·∫øp
    if (soDienThoai && soDienThoai.trim() !== '') {
        const encodedText = encodeURIComponent(shareText);
        const zaloUrl = `https://zalo.me/${soDienThoai}?text=${encodedText}`;
        window.open(zaloUrl, '_blank');
    } else {
        // N·∫øu kh√¥ng c√≥ s·ªë ƒëi·ªán tho·∫°i, m·ªü Zalo v·ªõi tin nh·∫Øn s·∫µn
        const encodedText = encodeURIComponent(shareText);
        const zaloUrl = `https://zalo.me/?msg=${encodedText}`;
        window.open(zaloUrl, '_blank');
    }
}

        // H√†m l·∫•y danh s√°ch h·ªôi vi√™n d·∫°ng array
        function getHoiVienArray() {
            if (!currentHui || !currentHui.hoiVien) return [];

            let hoiVienArray = Array.isArray(currentHui.hoiVien)
                ? currentHui.hoiVien
                : Object.keys(currentHui.hoiVien).map(key => ({
                    ...currentHui.hoiVien[key],
                    id: key
                }));

            // L·ªçc b·ªè ph·∫ßn t·ª≠ kh√¥ng c√≥ t√™n
            hoiVienArray = hoiVienArray.filter(hv => hv && hv.ten);

            // L·ªçc tr√πng ID ho·∫∑c tr√πng t√™n + s·ªë ch√¢n
            const unique = [];
            const seen = new Set();
            for (const hv of hoiVienArray) {
                const key = hv.id || `${hv.ten}_${hv.soChan}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(hv);
                }
            }

            return unique;
        }

        // ƒê√°nh d·∫•u ƒë√£ ƒë√≥ng ti·ªÅn
        async function markAsPaid(hoiVienId) {
            if (!currentPeriod) {
            alert('Vui l√≤ng ch·ªçn k·ª≥ ƒë√≥ng h·ª•i tr∆∞·ªõc');
            return;
        }

        try {
            const hoiVienPath = `users/${currentUser.uid}/dayhui/${currentHuiId}/hoiVien/${hoiVienId}/daDong/${currentPeriod}`;
            const hoiVienRef = database.ref(hoiVienPath);
            await hoiVienRef.set(true);
            
            console.log(`‚úÖ ƒê√£ ƒë√°nh d·∫•u h·ªôi vi√™n ${hoiVienId} ƒë√£ ƒë√≥ng k·ª≥ ${currentPeriod}`);
            
            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c cho CH·ªà NG∆Ø·ªúI ƒê√ì
            updateSingleMemberUI(hoiVienId, true);
            
        } catch (error) {
            console.error('‚ùå L·ªói khi ƒë√°nh d·∫•u ƒë√£ ƒë√≥ng:', error);
            alert('L·ªói: ' + error.message);
        }
    }

        // H·ªßy ƒë√°nh d·∫•u ƒë√£ ƒë√≥ng
        async function markAsUnpaid(hoiVienId) {
            if (!currentPeriod) {
            alert('Vui l√≤ng ch·ªçn k·ª≥ ƒë√≥ng h·ª•i tr∆∞·ªõc');
            return;
        }

        try {
            const hoiVienPath = `users/${currentUser.uid}/dayhui/${currentHuiId}/hoiVien/${hoiVienId}/daDong/${currentPeriod}`;
            const hoiVienRef = database.ref(hoiVienPath);
            await hoiVienRef.remove();
            
            console.log(`‚úÖ ƒê√£ h·ªßy ƒë√°nh d·∫•u ƒë√≥ng ti·ªÅn cho h·ªôi vi√™n ${hoiVienId} k·ª≥ ${currentPeriod}`);
            
            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c cho CH·ªà NG∆Ø·ªúI ƒê√ì
            updateSingleMemberUI(hoiVienId, false);
            
        } catch (error) {
            console.error('‚ùå L·ªói khi h·ªßy ƒë√°nh d·∫•u:', error);
            alert('L·ªói: ' + error.message);
        }
    }
    // C·∫≠p nh·∫≠t UI cho CH·ªà M·ªòT NG∆Ø·ªúI
    function updateSingleMemberUI(hoiVienId, isPaid) {
        const rows = document.querySelectorAll('#memberTableBody tr');
        
        rows.forEach(row => {
            // T√¨m ƒë√∫ng h√†ng c·ªßa ng∆∞·ªùi ƒë∆∞·ª£c click
            const buttons = row.querySelector('.action-buttons');
            if (buttons && buttons.innerHTML.includes(`'${hoiVienId}'`)) {
                
                // L·∫•y th√¥ng tin h·ªôi vi√™n
                const hoiVien = getHoiVienById(hoiVienId);
                const soDienThoai = hoiVien ? (hoiVien.soDienThoai || hoiVien.phone || '') : '';
                const soTienPhaiDong = calculatePaymentAmount(hoiVien);
                
                if (isPaid) {
                    // C·∫≠p nh·∫≠t th√†nh ƒê√É ƒê√ìNG
                    row.classList.remove('not-paid');
                    row.classList.add('paid');
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge bg-success">ƒê√£ ƒë√≥ng</span>';
                    
                    // C·∫≠p nh·∫≠t n√∫t thao t√°c - CH·ªà HI·ªÇN TH·ªä N√öT "H·ª¶Y ƒê√ìNG"
                    buttons.innerHTML = `
                        <button class="btn btn-sm btn-outline-secondary" onclick="markAsUnpaid('${hoiVienId}')">
                            <i class="fas fa-times"></i> H·ªßy ƒë√≥ng
                        </button>
                    `;
                } else {
                    // C·∫≠p nh·∫≠t th√†nh CH∆ØA ƒê√ìNG
                    row.classList.remove('paid');
                    row.classList.add('not-paid');
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge bg-danger">Ch∆∞a ƒë√≥ng</span>';
                    
                    // C·∫≠p nh·∫≠t n√∫t thao t√°c - HI·ªÇN TH·ªä C·∫¢ 2 N√öT
                    buttons.innerHTML = `
                        <button class="btn btn-sm btn-success" onclick="markAsPaid('${hoiVienId}')">
                            <i class="fas fa-check"></i> ƒê√°nh d·∫•u ƒë√£ ƒë√≥ng
                        </button>
                        <button class="btn btn-sm btn-zalo" onclick="shareMemberPayment('${hoiVienId}', '${hoiVien.ten}', ${soTienPhaiDong}, '${soDienThoai}')">
                            <i class="fab fa-zalo"></i> Zalo
                        </button>
                    `;
                }
                
                // Ch·ªâ c·∫≠p nh·∫≠t m·ªôt ng∆∞·ªùi r·ªìi d·ª´ng l·∫°i
                return;
            }
        });

        // Ki·ªÉm tra l·∫°i tr·∫°ng th√°i t·∫•t c·∫£
        checkAllPaidStatus();
    }
        // C·∫≠p nh·∫≠t UI tr·∫°ng th√°i ƒë√≥ng ti·ªÅn ngay l·∫≠p t·ª©c
    function updateUIPaymentStatus(hoiVienId, isPaid) {
        const rows = document.querySelectorAll('#memberTableBody tr');
        
        rows.forEach(row => {
            const buttons = row.querySelector('.action-buttons');
            if (buttons && buttons.innerHTML.includes(hoiVienId)) {
                // C·∫≠p nh·∫≠t class v√† tr·∫°ng th√°i
                if (isPaid) {
                    row.classList.remove('not-paid');
                    row.classList.add('paid');
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge bg-success">ƒê√£ ƒë√≥ng</span>';
                    
                    // C·∫≠p nh·∫≠t n√∫t thao t√°c - ·∫®n n√∫t Zalo
                    buttons.innerHTML = `
                        <button class="btn btn-sm btn-outline-secondary" onclick="markAsUnpaid('${hoiVienId}')">
                            <i class="fas fa-times"></i> H·ªßy ƒë√≥ng
                        </button>
                    `;
                } else {
                    row.classList.remove('paid');
                    row.classList.add('not-paid');
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge bg-danger">Ch∆∞a ƒë√≥ng</span>';
                    
                    // C·∫≠p nh·∫≠t n√∫t thao t√°c - Hi·ªÉn th·ªã n√∫t Zalo
                    const hoiVien = getHoiVienById(hoiVienId);
                    const soDienThoai = hoiVien ? (hoiVien.soDienThoai || hoiVien.phone || '') : '';
                    const soTienPhaiDong = calculatePaymentAmount(hoiVien);
                    
                    buttons.innerHTML = `
                        <button class="btn btn-sm btn-success" onclick="markAsPaid('${hoiVienId}')">
                            <i class="fas fa-check"></i> ƒê√°nh d·∫•u ƒë√£ ƒë√≥ng
                        </button>
                        <button class="btn btn-sm btn-zalo" onclick="shareMemberPayment('${hoiVienId}', '${hoiVien.ten}', ${soTienPhaiDong}, '${soDienThoai}')">
                            <i class="fab fa-zalo"></i> Zalo
                        </button>
                    `;
                }
            }
        });

        // Ki·ªÉm tra xem c√≤n th√†nh vi√™n n√†o ch∆∞a ƒë√≥ng kh√¥ng
        checkAllPaidStatus();
    }

    // H√†m l·∫•y th√¥ng tin h·ªôi vi√™n theo ID
    function getHoiVienById(hoiVienId) {
        const hoiVienArray = getHoiVienArray();
        return hoiVienArray.find(hv => hv.id === hoiVienId);
    }

    // H√†m t√≠nh s·ªë ti·ªÅn ph·∫£i ƒë√≥ng
    function calculatePaymentAmount(hoiVien) {
        let soTienPhaiDong = currentHui.tienHui || 0;
        const soKyDaHot = currentHui.soKy || 0;
        
        if (currentPeriod <= soKyDaHot) {
            soTienPhaiDong -= currentThamKeu;
        }
        
        return soTienPhaiDong;
    }

    // Ki·ªÉm tra tr·∫°ng th√°i ƒë√≥ng ti·ªÅn c·ªßa t·∫•t c·∫£ th√†nh vi√™n
    function checkAllPaidStatus() {
        const rows = document.querySelectorAll('#memberTableBody tr');
        let allPaid = true;
        let hasMembersToPay = false;

        rows.forEach(row => {
            if (row.classList.contains('not-paid') && !row.classList.contains('hot-person') && !row.classList.contains('already-hot')) {
                allPaid = false;
                hasMembersToPay = true;
            }
            
            if (!row.classList.contains('hot-person') && !row.classList.contains('already-hot')) {
                hasMembersToPay = true;
            }
        });

        // Hi·ªÉn th·ªã/·∫©n n√∫t "ƒê√°nh d·∫•u t·∫•t c·∫£"
        if (hasMembersToPay && !allPaid) {
            document.getElementById('markAllBtn').style.display = 'block';
        } else {
            document.getElementById('markAllBtn').style.display = 'none';
        }
    }

        // ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë√≥ng
        async function markAllAsPaid() {
            if (!currentPeriod) {
                alert('Vui l√≤ng ch·ªçn k·ª≥ ƒë√≥ng h·ª•i tr∆∞·ªõc');
                return;
            }

            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√°nh d·∫•u T·∫§T C·∫¢ h·ªôi vi√™n ƒë√£ ƒë√≥ng ti·ªÅn cho k·ª≥ ${currentPeriod}?`)) {
                return;
            }

            try {
                const hoiVienArray = getHoiVienArray();
                const updatePromises = [];

                for (const hoiVien of hoiVienArray) {
                    // B·ªè qua ng∆∞·ªùi ƒë√£ h·ªët k·ª≥ n√†y ho·∫∑c ƒë√£ h·ªët tr∆∞·ªõc ƒë√≥
                    const isHotPerson = currentHotPerson && hoiVien.ten === currentHotPerson;
                    const daHotTruoc = hoiVien.daHot && hoiVien.kyDaHot < currentPeriod;
                    
                    if (isHotPerson || daHotTruoc) {
                        continue;
                    }

                    const hoiVienPath = `users/${currentUser.uid}/dayhui/${currentHuiId}/hoiVien/${hoiVien.id}/daDong/${currentPeriod}`;
                    const hoiVienRef = database.ref(hoiVienPath);
                    updatePromises.push(hoiVienRef.set(true));
                }

                await Promise.all(updatePromises);
                console.log(`‚úÖ ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ h·ªôi vi√™n ƒë√£ ƒë√≥ng k·ª≥ ${currentPeriod}`);
                loadMemberPaymentStatus();
                
            } catch (error) {
                console.error('‚ùå L·ªói khi ƒë√°nh d·∫•u t·∫•t c·∫£:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(amount);
        }
        
        // ƒêƒÉng xu·∫•t
        function signOut() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                auth.signOut();
            }
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        document.addEventListener('DOMContentLoaded', function() {
            if (initializeFirebase()) {
                checkAuthState();
            }
        });
    </script>
</body>
</html>
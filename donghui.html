<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đóng Hụi - Quản Lý Hụi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
    :root {
        --primary-color: #3498db;
        --secondary-color: #2c3e50;
        --accent-color: #e74c3c;
        --light-color: #ecf0f1;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        color: #333;
        padding: 20px;
    }
    
    .header {
        background-color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    
    .card-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: 10px 10px 0 0 !important;
        padding: 15px 20px;
        font-weight: 600;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border: none;
    }
    
    .btn-primary:hover {
        background-color: #2980b9;
    }
    
    .btn-success {
        background-color: var(--success-color);
        border: none;
    }

    .btn-zalo {
        background-color: #0068ff;
        color: white;
        border: none;
    }
    
    .btn-zalo:hover {
        background-color: #0051cc;
        color: white;
    }
    
    .back-btn {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 20px;
        display: inline-block;
    }
    
    .back-btn:hover {
        text-decoration: underline;
    }
    
    .member-table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .member-table th {
        background-color: var(--secondary-color);
        color: white;
        padding: 12px 15px;
        text-align: center;
        font-weight: 600;
        position: sticky;
        top: 0;
    }
    
    .member-table td {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        text-align: center;
        vertical-align: middle;
    }
    
    .member-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .member-table tr:hover {
        background-color: #e9ecef;
    }
    
    .paid {
        background-color: #d4edda !important;
        color: #155724;
    }
    
    .not-paid {
        background-color: #f8d7da !important;
        color: #721c24;
    }
    
    /* CSS FIXED cho người hốt - ĐẶT Ở ĐÂY ĐỂ CÓ ĐỘ ƯU TIÊN CAO */
    .member-table tr.hot-person {
        background: linear-gradient(135deg, #c8f7c5 0%, #87d18d 100%) !important;
        color: #145214 !important;
        font-weight: 600;
        border-left: 4px solid #27ae60;
    }
    
    .member-table tr.hot-person td {
        background: transparent !important;
        border-color: #27ae60 !important;
    }
    
    .member-table tr.already-hot {
        background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%) !important;
        color: #636e72 !important;
        border-left: 4px solid #636e72;
    }
    
    .member-table tr.already-hot td {
        background: transparent !important;
        border-color: #b2bec3 !important;
    }
    
    /* Đảm bảo ghi đè tất cả các trạng thái khác */
    .member-table tr.hot-person.paid,
    .member-table tr.hot-person.not-paid,
    .member-table tr.already-hot.paid,
    .member-table tr.already-hot.not-paid {
        background: inherit !important;
    }
    
    .member-table tr.hot-person:hover,
    .member-table tr.already-hot:hover {
        opacity: 0.9;
    }
    
    .member-table tr.hot-person:nth-child(even),
    .member-table tr.already-hot:nth-child(even),
    .member-table tr.hot-person:nth-child(odd),
    .member-table tr.already-hot:nth-child(odd) {
        background: inherit !important;
    }
    
    .badge {
        font-size: 0.7em;
        margin-left: 5px;
    }
    
    .period-selector {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .hot-info-badge {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .share-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        border-left: 4px solid #0068ff;
    }

    .no-actions {
        color: #6c757d;
        font-style: italic;
    }
    
    .member-table th:nth-child(3),
    .member-table td:nth-child(3) {
        width: 150px;
    }

    .phone-column {
        direction: ltr;
        text-align: center;
    }

    .zalo-chat-btn {
        display: inline-block;
        padding: 6px 12px;
        background: #0068FF;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.8em;
        margin-top: 4px;
    }

    .zalo-chat-btn:hover {
        background: #0051cc;
        color: white;
        text-decoration: none;
    }

    /* Responsive cho mobile */
    @media (max-width: 768px) {
        .member-table th:nth-child(3),
        .member-table td:nth-child(3) {
            width: 120px;
        }
        
        .phone-column {
            font-size: 0.8em;
        }
        
        .zalo-chat-btn {
            padding: 4px 8px;
            font-size: 0.7em;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 3px;
        }
        
        .action-buttons .btn {
            font-size: 0.7em;
            padding: 0.2rem 0.4rem;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <a href="dayhui.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Quay lại Danh sách dây hụi
        </a>
        
        <div class="header">
            <h2><i class="fas fa-money-bill-wave"></i> Đóng Hụi</h2>
            <div>
                <span class="me-3">Xin chào, <span id="userEmail"></span></span>
                <button class="btn btn-outline-secondary" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </div>

        <!-- Thông tin dây hụi -->
        <div class="summary-card">
            <div class="row">
                <div class="col-md-6">
                    <h4 id="huiNameDisplay">[Tên dây hụi]</h4>
                    <p class="mb-1">Tiền hụi: <strong id="tienHuiDisplay">0đ</strong></p>
                    <p class="mb-1">Tiền thảo: <strong id="tienThaoDisplay">0đ</strong></p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1">Kỳ hiện tại: <strong id="kyHienTaiDisplay">0</strong>/<span id="tongSoKyDisplay">0</span></p>
                    <p class="mb-1">Số hội viên: <strong id="soHoiVienDisplay">0</strong></p>
                    <p class="mb-0">Trạng thái: <strong id="trangThaiDisplay">-</strong></p>
                </div>
            </div>
        </div>

        <!-- Chọn kỳ đóng hụi -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-alt"></i> Chọn kỳ đóng hụi
            </div>
            <div class="card-body">
                <div class="period-selector">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label"><strong>Kỳ đóng hụi:</strong></label>
                            <select class="form-select" id="kyDongHui" onchange="loadMemberPaymentStatus()">
                                <option value="">Chọn kỳ...</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i> 
                                <span id="kyInfoText">Vui lòng chọn kỳ để xem danh sách hội viên cần đóng</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phần chia sẻ qua Zalo -->
                <div id="shareSection" class="share-section" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6><i class="fas fa-share-alt"></i> Chia sẻ thông tin đóng hụi</h6>
                            <p class="mb-1" id="shareInfoText">Thông tin kỳ đóng, ngày đóng và số tiền</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-zalo" onclick="copyShareInfo()">
                                <i class="fab fa-zalo"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh sách hội viên -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-users"></i> Danh sách hội viên cần đóng kỳ <span id="currentPeriodDisplay">-</span>
                <span id="hotPersonInfo" class="hot-info-badge ms-2" style="display: none;"></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="member-table">
                        <thead>
                            <tr>
                                <th width="50">STT</th>
                                <th>Hội viên</th>
                                <th width="150">Số điện thoại</th>
                                <th width="120">Số chân</th>
                                <th width="150">Trạng thái</th>
                                <th width="150">Số tiền phải đóng</th>
                                <th width="200">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Đang tải dữ liệu...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 text-end">
                    <button class="btn btn-success" onclick="markAllAsPaid()" id="markAllBtn" style="display: none;">
                        <i class="fas fa-check-double"></i> Đánh dấu tất cả đã đóng
                    </button>
                </div> 
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYV8na-Az2LAgpl6QM2Tiwr6Gm9yhXQZ0",
            authDomain: "quan-ly-hui-8ad1c.firebaseapp.com",
            databaseURL: "https://quan-ly-hui-8ad1c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quan-ly-hui-8ad1c",
            storageBucket: "quan-ly-hui-8ad1c.firebasestorage.app",
            messagingSenderId: "665511229865",
            appId: "1:665511229865:web:fe44f814fff618e35e6cb8"
        };

        let database;
        let auth;
        let currentUser = null;
        let currentHui = null;
        let currentHuiId = null;
        let currentPeriod = null;
        let currentHotPerson = null;
        let currentHotPersonId = null; // <-- Thêm biến này
        let currentThamKeu = 0;

        // Khởi tạo Firebase
        function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK chưa được tải');
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                auth = firebase.auth();
                console.log('✅ Firebase đã được khởi tạo thành công');
                return true;
            } catch (error) {
                console.error('❌ Lỗi khởi tạo Firebase:', error);
                return false;
            }
        }

        // Kiểm tra trạng thái đăng nhập
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('✅ Người dùng đã đăng nhập:', user.uid, user.email);
                    document.getElementById('userEmail').textContent = user.email;
                    loadHuiData();
                } else {
                    currentUser = null;
                    window.location.href = 'dayhui.html';
                }
            });
        }

        // Copy thông tin chia sẻ
function copyShareInfo() {
    const shareText = document.getElementById('shareInfoText').textContent;
    
    // Tạo một textarea tạm thời để copy
    const textarea = document.createElement('textarea');
    textarea.value = shareText;
    document.body.appendChild(textarea);
    textarea.select();
    textarea.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
            // Hiển thị thông báo thành công
            alert('✅ Đã copy thông báo đóng hụi! Bạn có thể dán vào Zalo hoặc các ứng dụng nhắn tin khác.');
        } else {
            alert('❌ Không thể copy thông báo. Vui lòng thử lại.');
        }
    } catch (err) {
        document.body.removeChild(textarea);
        alert('❌ Lỗi khi copy: ' + err);
    }
}

        // Lấy dữ liệu dây hụi từ URL parameter
        function getHuiIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('huiId');
        }

        // Tải dữ liệu dây hụi
        async function loadHuiData() {
            const huiId = getHuiIdFromURL();
            if (!huiId) {
                alert('Không tìm thấy thông tin dây hụi');
                window.location.href = 'dayhui.html';
                return;
            }

            currentHuiId = huiId;

            try {
                const huiRef = database.ref('users/' + currentUser.uid + '/dayhui/' + huiId);
                const snapshot = await huiRef.once('value');
                
                if (!snapshot.exists()) {
                    alert('Dây hụi không tồn tại');
                    window.location.href = 'dayhui.html';
                    return;
                }

                currentHui = snapshot.val();
                displayHuiInfo();
                loadPeriodSelector();
                
            } catch (error) {
                console.error('❌ Lỗi khi tải dữ liệu dây hụi:', error);
                alert('Lỗi khi tải dữ liệu: ' + error.message);
            }
        }

        // Hiển thị thông tin dây hụi
        function displayHuiInfo() {
            if (!currentHui) return;

            document.getElementById('huiNameDisplay').textContent = currentHui.tendayhui || 'Chưa có tên';
            document.getElementById('tienHuiDisplay').textContent = formatCurrency(currentHui.tienHui || 0);
            document.getElementById('tienThaoDisplay').textContent = formatCurrency(currentHui.tienThao || 0);
            document.getElementById('kyHienTaiDisplay').textContent = currentHui.soKy || 0;
            document.getElementById('tongSoKyDisplay').textContent = currentHui.tongSoKy || 0;
            
            // Tính số hội viên thực tế
            const soHoiVien = getHoiVienArray().length;
            document.getElementById('soHoiVienDisplay').textContent = soHoiVien;
            
            // Hiển thị trạng thái
            const soKyDaHot = currentHui.soKy || 0;
            const tongSoKy = currentHui.tongSoKy || 0;
            let trangThai = '';
            
            if (soKyDaHot === 0) {
                trangThai = 'Chờ bắt đầu';
            } else if (soKyDaHot > 0 && soKyDaHot < tongSoKy) {
                trangThai = 'Đang hoạt động';
            } else if (soKyDaHot === tongSoKy) {
                trangThai = 'Đã kết thúc';
            } else {
                trangThai = currentHui.trangThai || 'Không xác định';
            }
            
            document.getElementById('trangThaiDisplay').textContent = trangThai;
        }

        // Tải danh sách kỳ vào selector
        function loadPeriodSelector() {
            const periodSelect = document.getElementById('kyDongHui');
            periodSelect.innerHTML = '<option value="">Chọn kỳ...</option>';
            
            const tongSoKy = currentHui.tongSoKy || 0;
            const soKyDaHot = currentHui.soKy || 0;
            
            // Chỉ hiển thị các kỳ từ 1 đến kỳ hiện tại + 1 (nếu chưa kết thúc)
            const kyToiDa = tongSoKy;
            
            for (let i = 1; i <= kyToiDa; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Kỳ ${i}`;
                
                if (i <= soKyDaHot) {
                    option.textContent += ' (Đã hốt)';
                } else if (i === soKyDaHot + 1) {
                    option.textContent += ' (Kỳ hiện tại)';
                }
                
                periodSelect.appendChild(option);
            }
        }

        // Tải trạng thái đóng tiền của hội viên
        async function loadMemberPaymentStatus() {
            const periodSelect = document.getElementById('kyDongHui');
    currentPeriod = parseInt(periodSelect.value);
    
    if (!currentPeriod || currentPeriod < 1) {
        document.getElementById('memberTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                    Vui lòng chọn kỳ đóng hụi
                </td>
            </tr>
        `;
        document.getElementById('markAllBtn').style.display = 'none';
        document.getElementById('shareSection').style.display = 'none';
        document.getElementById('hotPersonInfo').style.display = 'none';
        return;
    }

    document.getElementById('currentPeriodDisplay').textContent = currentPeriod;
    
    // Reset thông tin người hốt
    currentHotPerson = null;
currentHotPersonId = null; // <-- Reset cả ID
currentThamKeu = 0;

try {
    // Lấy thông tin hốt hụi cho kỳ này
    const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot/${currentPeriod}`);
    const hotSnap = await hotRef.once('value');

    if (hotSnap.exists()) {
        const hotData = hotSnap.val();
        currentThamKeu = hotData.thamKeu || 0;

        // Tìm thông tin người hốt (ƯU TIÊN ID)
        if (hotData.nguoiHot) { // 'nguoiHot' là ID
            currentHotPersonId = hotData.nguoiHot; // <-- Lưu ID

            if (hotData.nguoiHotTen) {
                currentHotPerson = hotData.nguoiHotTen; // Lấy tên nếu có
            } else {
                // Nếu không có tên, tìm tên từ ID
                const hoiVienArray = getHoiVienArray();
                const nguoiHot = hoiVienArray.find(hv => hv.id === currentHotPersonId);
                if (nguoiHot) {
                    currentHotPerson = nguoiHot.ten;
                } else {
                    currentHotPerson = "(Không tìm thấy tên)";
                }
            }
        } else if (hotData.nguoiHotTen) { 
            // Fallback: Nếu chỉ có tên, không có ID (dữ liệu cũ)
            currentHotPerson = hotData.nguoiHotTen;
            const hoiVienArray = getHoiVienArray();
            const nguoiHot = hoiVienArray.find(hv => hv.ten === currentHotPerson);
            if (nguoiHot) {
                currentHotPersonId = nguoiHot.id; // Cố gắng tìm ID từ tên
            }
        }
    }

        // Hiển thị thông tin người hốt
        if (currentHotPerson) {
            document.getElementById('hotPersonInfo').style.display = 'inline-block';
            document.getElementById('hotPersonInfo').textContent = `Người hốt: ${currentHotPerson} - Thăm kêu: ${formatCurrency(currentThamKeu)}`;
        } else {
            document.getElementById('hotPersonInfo').style.display = 'none';
        }

        // Hiển thị thông tin kỳ
        const soKyDaHot = currentHui.soKy || 0;
        let kyInfo = '';
        
        if (currentPeriod <= soKyDaHot) {
            kyInfo = `Kỳ ${currentPeriod} đã được hốt. Hiển thị danh sách đóng tiền cho kỳ này.`;
            if (currentHotPerson) {
                kyInfo += ` Người hốt: ${currentHotPerson}`;
            }
        } else if (currentPeriod === soKyDaHot + 1) {
            kyInfo = `Kỳ ${currentPeriod} là kỳ hiện tại cần đóng tiền.`;
        } else {
            kyInfo = `Kỳ ${currentPeriod} là kỳ trong tương lai.`;
        }
        
        document.getElementById('kyInfoText').textContent = kyInfo;

        // Hiển thị phần chia sẻ
        document.getElementById('shareSection').style.display = 'block';
        updateShareInfo();

        const hoiVienArray = getHoiVienArray();
        const tableBody = document.getElementById('memberTableBody');
        
        if (hoiVienArray.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        Không có hội viên nào trong dây hụi này
                    </td>
                </tr>
            `;
            document.getElementById('markAllBtn').style.display = 'none';
            return;
        }

        let html = '';
        let allPaid = true;
        let hasMembersToPay = false;

        hoiVienArray.forEach((hoiVien, index) => {
    // Lấy số điện thoại từ dữ liệu hội viên
    const soDienThoai = hoiVien.soDienThoai || hoiVien.phone || '';
        
            // DEBUG trước
        console.log('=== DEBUG HOT PERSON ===');
        console.log('Current Hot Person ID:', currentHotPersonId);
        console.log('Current Hot Person Name:', currentHotPerson);
        console.log('Current HoiVien ID:', hoiVien.id);
        console.log('Current HoiVien Name:', hoiVien.ten);

    // Kiểm tra xem hội viên có phải là người hốt kỳ này không
    const isHotPerson = (() => {
    if (!currentHotPersonId && !currentHotPerson) return false;

    // Lấy phần trước dấu "_" (để so ID)
    const hotIdPrefix = (currentHotPersonId || '').split('_')[0];
    const memberIdPrefix = (hoiVien.id || '').split('_')[0];

    // Chuẩn hóa tên bỏ phần "(Chân ...)"
    const normalizeName = (name) => name
        ? name.toLowerCase().replace(/\(.*?\)/g, '').trim()
        : '';

    return (
        memberIdPrefix === hotIdPrefix || // so khớp ID
        normalizeName(hoiVien.ten) === normalizeName(currentHotPerson) // so khớp tên
    );
})();

console.log('Is Hot Person:', isHotPerson);
    
    if (isHotPerson) {
        // Người hốt kỳ này - TÔ MÀU TOÀN BỘ DÒNG
        html += `
            <tr class="hot-person">
                <td>${index + 1}</td>
                <td class="text-start">
                    <strong>${hoiVien.ten}</strong>
                    <span class="badge bg-danger">ĐÃ HỐT KỲ ${currentPeriod}</span>
                </td>
                <td class="phone-column">
                    ${soDienThoai ? `
                        <div>${soDienThoai}</div>
                        <a href="https://zalo.me/${soDienThoai}" class="zalo-chat-btn" target="_blank">
                            💬 Chat Zalo
                        </a>
                    ` : '<span class="text-muted">-</span>'}
                </td>
                <td>${hoiVien.soChan || 1}</td>
                <td>
                    <span class="badge bg-warning">Đã hốt</span>
                </td>
                <td>
                    <strong>${formatCurrency(0)}</strong>
                    <br>
                    <small class="text-muted">Không phải đóng</small>
                </td>
                <td class="no-actions">
                    Không cần thao tác
                </td>
            </tr>
        `;
        return;
    }

    // Kiểm tra xem hội viên đã hốt ở kỳ trước chưa
    const daHotTruoc = hoiVien.daHot && hoiVien.kyDaHot < currentPeriod;
    
    if (daHotTruoc) {
        // Đã hốt trước đó - TÔ MÀU TOÀN BỘ DÒNG
        html += `
            <tr class="already-hot">
                <td>${index + 1}</td>
                <td class="text-start">
                    <strong>${hoiVien.ten}</strong>
                    <span class="badge bg-secondary">Đã hốt kỳ ${hoiVien.kyDaHot}</span>
                </td>
                <td class="phone-column">
                    ${soDienThoai ? `
                        <div>${soDienThoai}</div>
                        <a href="https://zalo.me/${soDienThoai}" class="zalo-chat-btn" target="_blank">
                            💬 Chat Zalo
                        </a>
                    ` : '<span class="text-muted">-</span>'}
                </td>
                <td>${hoiVien.soChan || 1}</td>
                <td>
                    <span class="badge bg-secondary">Đã hốt</span>
                </td>
                <td>
                    <strong>${formatCurrency(currentHui.tienHui || 0)}</strong>
                    <br>
                    <small class="text-muted">Tiền hụi đủ</small>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-success" onclick="markAsPaid('${hoiVien.id}')">
                            <i class="fas fa-check"></i> Đã đóng
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="markAsUnpaid('${hoiVien.id}')">
                            <i class="fas fa-times"></i> Hủy
                        </button>
                        <button class="btn btn-sm btn-zalo" onclick="shareMemberPayment('${hoiVien.id}', '${hoiVien.ten}', ${currentHui.tienHui || 0}, '${soDienThoai}')">
                            <i class="fab fa-zalo"></i> Zalo
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

            hasMembersToPay = true;
            
            // Kiểm tra đã đóng tiền chưa
            const daDong = hoiVien.daDong && hoiVien.daDong[currentPeriod];
            
            if (!daDong) {
                allPaid = false;
            }

            // Tính số tiền phải đóng
            let soTienPhaiDong = currentHui.tienHui || 0;
            if (currentPeriod <= soKyDaHot) {
                // Nếu kỳ đã hốt thì trừ thăm kêu
                soTienPhaiDong -= currentThamKeu;
            }

            const rowClass = daDong ? 'paid' : 'not-paid';
            const statusText = daDong ? 'Đã đóng' : 'Chưa đóng';
            const statusBadge = daDong ? 'success' : 'danger';

            html += `
                <tr class="${rowClass}">
                    <td>${index + 1}</td>
                    <td class="text-start">
                        <strong>${hoiVien.ten}</strong>
                    </td>
                    <td class="phone-column">
                        ${soDienThoai ? `
                            <div>${soDienThoai}</div>
                            <a href="https://zalo.me/${soDienThoai}" class="zalo-chat-btn" target="_blank">
                                💬 Chat Zalo
                            </a>
                        ` : '<span class="text-muted">-</span>'}
                    </td>
                    <td>${hoiVien.soChan || 1}</td>
                    <td>
                        <span class="badge bg-${statusBadge}">${statusText}</span>
                    </td>
                    <td>
                        <strong>${formatCurrency(soTienPhaiDong)}</strong>
                        ${currentThamKeu > 0 ? `<br><small class="text-muted">(Hụi ${formatCurrency(currentHui.tienHui || 0)} - Thăm kêu ${formatCurrency(currentThamKeu)})</small>` : ''}
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${!daDong ? `
                                <button class="btn btn-sm btn-success" onclick="markAsPaid('${hoiVien.id}')">
                                    <i class="fas fa-check"></i> Đánh dấu đã đóng
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-secondary" onclick="markAsUnpaid('${hoiVien.id}')">
                                    <i class="fas fa-times"></i> Hủy đóng
                                </button>
                            `}
                            
                        </div>
                    </td>
                </tr>
            `;
        });

        if (!hasMembersToPay) {
            html = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        Tất cả hội viên đã hốt hoặc không cần đóng tiền cho kỳ này
                    </td>
                </tr>
            `;
        }

        tableBody.innerHTML = html;
        
        // Hiển thị nút "Đánh dấu tất cả" nếu có thành viên chưa đóng
        if (hasMembersToPay && !allPaid) {
            document.getElementById('markAllBtn').style.display = 'block';
        } else {
            document.getElementById('markAllBtn').style.display = 'none';
        }

    } catch (error) {
        console.error('❌ Lỗi khi tải trạng thái đóng tiền:', error);
        document.getElementById('memberTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    Lỗi khi tải dữ liệu: ${error.message}
                </td>
            </tr>
        `;
    }
}

        // Cập nhật thông tin chia sẻ
        function updateShareInfo() {
            const soKyDaHot = currentHui.soKy || 0;
    const today = new Date().toLocaleDateString('vi-VN');
    
    let shareText = `THÔNG BÁO ĐÓNG HỤI\n`;
    shareText += `══════════════════\n`;
    shareText += `Dây hụi: ${currentHui.tendayhui || 'Chưa đặt tên'}\n`;
    shareText += `Kỳ: ${currentPeriod}\n`;
    shareText += `Ngày đóng: ${today}\n\n`;
    
    if (currentPeriod <= soKyDaHot) {
        shareText += `💰 THÔNG TIN TIỀN HỤI:\n`;
        shareText += `• Tiền hụi: ${formatCurrency(currentHui.tienHui || 0)}\n`;
        if (currentThamKeu > 0) {
            shareText += `• Thăm kêu: ${formatCurrency(currentThamKeu)}\n`;
            shareText += `• Thực đóng: ${formatCurrency((currentHui.tienHui || 0) - currentThamKeu)}\n`;
        }
        if (currentHotPerson) {
            shareText += `• Người hốt: ${currentHotPerson}\n`;
        }
    } else {
        shareText += `💰 SỐ TIỀN: ${formatCurrency(currentHui.tienHui || 0)}\n`;
    }
    
    shareText += `\n📋 LƯU Ý:\n`;
    shareText += `• Vui lòng đóng tiền đúng hạn\n`;
    shareText += `• Có thể chuyển khoản hoặc tiền mặt\n`;
    shareText += `• Liên hệ nếu có thắc mắc`;
    
    document.getElementById('shareInfoText').textContent = shareText;
}

        // Chia sẻ qua Zalo
        function shareViaZalo() {
            const shareText = document.getElementById('shareInfoText').textContent;
    const encodedText = encodeURIComponent(shareText);
    
    // Mở Zalo với tin nhắn đã soạn sẵn, người dùng có thể chọn người nhận
    const zaloUrl = `https://zalo.me/?msg=${encodedText}`;
    window.open(zaloUrl, '_blank');
}

        // Hàm lấy số điện thoại từ tên hội viên (tìm trong danh sách đã lưu)
function getPhoneNumberFromMemberName(memberName) {
    // Tìm trong danh sách hội viên hiện tại của dây hụi
    const hoiVienArray = getHoiVienArray();
    const hoiVien = hoiVienArray.find(hv => hv.ten === memberName);
    
    if (hoiVien && (hoiVien.soDienThoai || hoiVien.phone)) {
        return hoiVien.soDienThoai || hoiVien.phone;
    }
    
    return '';
}

        // Chia sẻ thông tin đóng tiền của từng hội viên qua Zalo
        function shareMemberPayment(hoiVienId, tenHoiVien, soTien, soDienThoai) {
    const today = new Date().toLocaleDateString('vi-VN');
    const soKyDaHot = currentHui.soKy || 0;
    
    let shareText = `Thông báo đóng hụi\n`;
    shareText += `Dây hụi: ${currentHui.tendayhui || 'Chưa đặt tên'}\n`;
    shareText += `Kỳ: ${currentPeriod}\n`;
    shareText += `Hội viên: ${tenHoiVien}\n`;
    
    if (currentPeriod <= soKyDaHot && currentThamKeu > 0) {
        shareText += `Tiền hụi: ${formatCurrency(currentHui.tienHui || 0)}\n`;
        shareText += `Tiền thảo: ${formatCurrency(currentThamKeu)}\n`;
        shareText += `Số tiền cần đóng: ${formatCurrency(soTien)}\n`;
    } else {
        shareText += `Số tiền: ${formatCurrency(soTien)}\n`;
    }
    
    shareText += `Ngày đóng: ${today}\n`;
    shareText += `Hình thức: Chuyển khoản/Tiền mặt`;
    
    // Nếu có số điện thoại, mở Zalo chat trực tiếp
    if (soDienThoai && soDienThoai.trim() !== '') {
        const encodedText = encodeURIComponent(shareText);
        const zaloUrl = `https://zalo.me/${soDienThoai}?text=${encodedText}`;
        window.open(zaloUrl, '_blank');
    } else {
        // Nếu không có số điện thoại, mở Zalo với tin nhắn sẵn
        const encodedText = encodeURIComponent(shareText);
        const zaloUrl = `https://zalo.me/?msg=${encodedText}`;
        window.open(zaloUrl, '_blank');
    }
}

        // Hàm lấy danh sách hội viên dạng array
        function getHoiVienArray() {
            if (!currentHui || !currentHui.hoiVien) return [];

            let hoiVienArray = Array.isArray(currentHui.hoiVien)
                ? currentHui.hoiVien
                : Object.keys(currentHui.hoiVien).map(key => ({
                    ...currentHui.hoiVien[key],
                    id: key
                }));

            // Lọc bỏ phần tử không có tên
            hoiVienArray = hoiVienArray.filter(hv => hv && hv.ten);

            // Lọc trùng ID hoặc trùng tên + số chân
            const unique = [];
            const seen = new Set();
            for (const hv of hoiVienArray) {
                const key = hv.id || `${hv.ten}_${hv.soChan}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(hv);
                }
            }

            return unique;
        }

        // Đánh dấu đã đóng tiền
        async function markAsPaid(hoiVienId) {
            if (!currentPeriod) {
            alert('Vui lòng chọn kỳ đóng hụi trước');
            return;
        }

        try {
            const hoiVienPath = `users/${currentUser.uid}/dayhui/${currentHuiId}/hoiVien/${hoiVienId}/daDong/${currentPeriod}`;
            const hoiVienRef = database.ref(hoiVienPath);
            await hoiVienRef.set(true);
            
            console.log(`✅ Đã đánh dấu hội viên ${hoiVienId} đã đóng kỳ ${currentPeriod}`);
            
            // Cập nhật UI ngay lập tức cho CHỈ NGƯỜI ĐÓ
            updateSingleMemberUI(hoiVienId, true);
            
        } catch (error) {
            console.error('❌ Lỗi khi đánh dấu đã đóng:', error);
            alert('Lỗi: ' + error.message);
        }
    }

        // Hủy đánh dấu đã đóng
        async function markAsUnpaid(hoiVienId) {
            if (!currentPeriod) {
            alert('Vui lòng chọn kỳ đóng hụi trước');
            return;
        }

        try {
            const hoiVienPath = `users/${currentUser.uid}/dayhui/${currentHuiId}/hoiVien/${hoiVienId}/daDong/${currentPeriod}`;
            const hoiVienRef = database.ref(hoiVienPath);
            await hoiVienRef.remove();
            
            console.log(`✅ Đã hủy đánh dấu đóng tiền cho hội viên ${hoiVienId} kỳ ${currentPeriod}`);
            
            // Cập nhật UI ngay lập tức cho CHỈ NGƯỜI ĐÓ
            updateSingleMemberUI(hoiVienId, false);
            
        } catch (error) {
            console.error('❌ Lỗi khi hủy đánh dấu:', error);
            alert('Lỗi: ' + error.message);
        }
    }
    // Cập nhật UI cho CHỈ MỘT NGƯỜI
    function updateSingleMemberUI(hoiVienId, isPaid) {
        const rows = document.querySelectorAll('#memberTableBody tr');
        
        rows.forEach(row => {
            // Tìm đúng hàng của người được click
            const buttons = row.querySelector('.action-buttons');
            if (buttons && buttons.innerHTML.includes(`'${hoiVienId}'`)) {
                
                // Lấy thông tin hội viên
                const hoiVien = getHoiVienById(hoiVienId);
                const soDienThoai = hoiVien ? (hoiVien.soDienThoai || hoiVien.phone || '') : '';
                const soTienPhaiDong = calculatePaymentAmount(hoiVien);
                
                if (isPaid) {
                    // Cập nhật thành ĐÃ ĐÓNG
                    row.classList.remove('not-paid');
                    row.classList.add('paid');
                    
                    // Cập nhật trạng thái
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge bg-success">Đã đóng</span>';
                    
                    // Cập nhật nút thao tác - CHỈ HIỂN THỊ NÚT "HỦY ĐÓNG"
                    buttons.innerHTML = `
                        <button class="btn btn-sm btn-outline-secondary" onclick="markAsUnpaid('${hoiVienId}')">
                            <i class="fas fa-times"></i> Hủy đóng
                        </button>
                    `;
                } else {
                    // Cập nhật thành CHƯA ĐÓNG
                    row.classList.remove('paid');
                    row.classList.add('not-paid');
                    
                    // Cập nhật trạng thái
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge bg-danger">Chưa đóng</span>';
                    
                    // Cập nhật nút thao tác - HIỂN THỊ CẢ 2 NÚT
                    buttons.innerHTML = `
                        <button class="btn btn-sm btn-success" onclick="markAsPaid('${hoiVienId}')">
                            <i class="fas fa-check"></i> Đánh dấu đã đóng
                        </button>
                        <button class="btn btn-sm btn-zalo" onclick="shareMemberPayment('${hoiVienId}', '${hoiVien.ten}', ${soTienPhaiDong}, '${soDienThoai}')">
                            <i class="fab fa-zalo"></i> Zalo
                        </button>
                    `;
                }
                
                // Chỉ cập nhật một người rồi dừng lại
                return;
            }
        });

        // Kiểm tra lại trạng thái tất cả
        checkAllPaidStatus();
    }
        // Cập nhật UI trạng thái đóng tiền ngay lập tức
    function updateUIPaymentStatus(hoiVienId, isPaid) {
        const rows = document.querySelectorAll('#memberTableBody tr');
        
        rows.forEach(row => {
            const buttons = row.querySelector('.action-buttons');
            if (buttons && buttons.innerHTML.includes(hoiVienId)) {
                // Cập nhật class và trạng thái
                if (isPaid) {
                    row.classList.remove('not-paid');
                    row.classList.add('paid');
                    
                    // Cập nhật trạng thái
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge bg-success">Đã đóng</span>';
                    
                    // Cập nhật nút thao tác - Ẩn nút Zalo
                    buttons.innerHTML = `
                        <button class="btn btn-sm btn-outline-secondary" onclick="markAsUnpaid('${hoiVienId}')">
                            <i class="fas fa-times"></i> Hủy đóng
                        </button>
                    `;
                } else {
                    row.classList.remove('paid');
                    row.classList.add('not-paid');
                    
                    // Cập nhật trạng thái
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge bg-danger">Chưa đóng</span>';
                    
                    // Cập nhật nút thao tác - Hiển thị nút Zalo
                    const hoiVien = getHoiVienById(hoiVienId);
                    const soDienThoai = hoiVien ? (hoiVien.soDienThoai || hoiVien.phone || '') : '';
                    const soTienPhaiDong = calculatePaymentAmount(hoiVien);
                    
                    buttons.innerHTML = `
                        <button class="btn btn-sm btn-success" onclick="markAsPaid('${hoiVienId}')">
                            <i class="fas fa-check"></i> Đánh dấu đã đóng
                        </button>
                        <button class="btn btn-sm btn-zalo" onclick="shareMemberPayment('${hoiVienId}', '${hoiVien.ten}', ${soTienPhaiDong}, '${soDienThoai}')">
                            <i class="fab fa-zalo"></i> Zalo
                        </button>
                    `;
                }
            }
        });

        // Kiểm tra xem còn thành viên nào chưa đóng không
        checkAllPaidStatus();
    }

    // Hàm lấy thông tin hội viên theo ID
    function getHoiVienById(hoiVienId) {
        const hoiVienArray = getHoiVienArray();
        return hoiVienArray.find(hv => hv.id === hoiVienId);
    }

    // Hàm tính số tiền phải đóng
    function calculatePaymentAmount(hoiVien) {
        let soTienPhaiDong = currentHui.tienHui || 0;
        const soKyDaHot = currentHui.soKy || 0;
        
        if (currentPeriod <= soKyDaHot) {
            soTienPhaiDong -= currentThamKeu;
        }
        
        return soTienPhaiDong;
    }

    // Kiểm tra trạng thái đóng tiền của tất cả thành viên
    function checkAllPaidStatus() {
        const rows = document.querySelectorAll('#memberTableBody tr');
        let allPaid = true;
        let hasMembersToPay = false;

        rows.forEach(row => {
            if (row.classList.contains('not-paid') && !row.classList.contains('hot-person') && !row.classList.contains('already-hot')) {
                allPaid = false;
                hasMembersToPay = true;
            }
            
            if (!row.classList.contains('hot-person') && !row.classList.contains('already-hot')) {
                hasMembersToPay = true;
            }
        });

        // Hiển thị/ẩn nút "Đánh dấu tất cả"
        if (hasMembersToPay && !allPaid) {
            document.getElementById('markAllBtn').style.display = 'block';
        } else {
            document.getElementById('markAllBtn').style.display = 'none';
        }
    }

        // Đánh dấu tất cả đã đóng
        async function markAllAsPaid() {
            if (!currentPeriod) {
                alert('Vui lòng chọn kỳ đóng hụi trước');
                return;
            }

            if (!confirm(`Bạn có chắc chắn muốn đánh dấu TẤT CẢ hội viên đã đóng tiền cho kỳ ${currentPeriod}?`)) {
                return;
            }

            try {
                const hoiVienArray = getHoiVienArray();
                const updatePromises = [];

                for (const hoiVien of hoiVienArray) {
                    // Bỏ qua người đã hốt kỳ này hoặc đã hốt trước đó
                    const isHotPerson = currentHotPerson && hoiVien.ten === currentHotPerson;
                    const daHotTruoc = hoiVien.daHot && hoiVien.kyDaHot < currentPeriod;
                    
                    if (isHotPerson || daHotTruoc) {
                        continue;
                    }

                    const hoiVienPath = `users/${currentUser.uid}/dayhui/${currentHuiId}/hoiVien/${hoiVien.id}/daDong/${currentPeriod}`;
                    const hoiVienRef = database.ref(hoiVienPath);
                    updatePromises.push(hoiVienRef.set(true));
                }

                await Promise.all(updatePromises);
                console.log(`✅ Đã đánh dấu tất cả hội viên đã đóng kỳ ${currentPeriod}`);
                loadMemberPaymentStatus();
                
            } catch (error) {
                console.error('❌ Lỗi khi đánh dấu tất cả:', error);
                alert('Lỗi: ' + error.message);
            }
        }

        // Định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(amount);
        }
        
        // Đăng xuất
        function signOut() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                auth.signOut();
            }
        }

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', function() {
            if (initializeFirebase()) {
                checkAuthState();
            }
        });
    </script>
</body>
</html>
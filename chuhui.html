<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Tin Chủ Hụi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
}

/* Thanh header cố định */
.fixed-header {
    background-color: #34495e;
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    top: 0;
    width: 100%;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    height: 60px;
}

.fixed-header h2 {
    font-size: 1.3rem;
    font-weight: normal;
}

.fixed-header .logout-btn {
    background-color: transparent;
    border: 1px solid white;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 0.9rem;
}

.fixed-header .logout-btn:hover {
    background-color: #e74c3c;
    border-color: #e74c3c;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    margin-top: 60px;
}

.card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    border: none;
    transition: transform 0.3s, box-shadow 0.3s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
}

.card-header {
    background-color: #34495e;
    color: white;
    border-radius: 8px 8px 0 0 !important;
    padding: 15px 20px;
    font-weight: 600;
}

.btn-primary {
    background-color: #3498db;
    border: none;
}

.btn-primary:hover {
    background-color: #2980b9;
}

.btn-success {
    background-color: #2ecc71;
    border: none;
}

.btn-success:hover {
    background-color: #27ae60;
}

.btn-danger {
    background-color: #e74c3c;
    border: none;
}

.btn-danger:hover {
    background-color: #c0392b;
}

.back-btn {
    color: #3498db;
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 20px;
    display: inline-block;
}

.back-btn:hover {
    text-decoration: underline;
    color: #2980b9;
}

.login-prompt {
    text-align: center;
    padding: 40px 20px;
}

.chu-hui-selector {
    margin-bottom: 20px;
}

.form-control:read-only {
    background-color: #f8f9fa;
}

.stat-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
    transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.stat-card h3 {
    margin-bottom: 10px;
    color: #2c3e50;
    font-size: 1.8rem;
}

.stat-card p {
    color: #7f8c8d;
    font-size: 0.9rem;
}

/* Header section improvements */
.header .d-flex {
    flex-wrap: wrap;
    gap: 15px;
}

.header h2 {
    color: #2c3e50;
    font-weight: 600;
}

/* Form improvements */
#chuhuiForm .form-label {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 8px;
}

#chuhuiForm .form-control {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px 12px;
    transition: border-color 0.3s, box-shadow 0.3s;
}

#chuhuiForm .form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

/* Button group improvements */
.button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.button-group .btn {
    flex: 1;
    min-width: 120px;
}

/* Statistics card improvements */
.card-body .d-flex {
    padding: 8px 0;
    border-bottom: 1px solid #f8f9fa;
}

.card-body .d-flex:last-child {
    border-bottom: none;
}

.card-body strong {
    color: #2c3e50;
    font-weight: 600;
}

/* List group improvements */
.list-group-item {
    border: none;
    border-bottom: 1px solid #f8f9fa;
    padding: 12px 15px;
}

.list-group-item:last-child {
    border-bottom: none;
}

.list-group-item small {
    color: #666;
}

/* Modal improvements */
.modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.modal-title {
    font-weight: 600;
    color: #2c3e50;
}

/* Cải tiến responsive cho tablet */
@media (max-width: 1024px) {
    .fixed-header {
        padding: 10px 15px;
    }
    
    .container {
        padding: 15px;
    }
    
    .header .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .header .d-flex > div {
        margin-top: 15px;
        width: 100%;
    }
    
    #chuHuiSelector {
        width: 100% !important;
        margin-bottom: 10px;
    }
    
    .header .d-flex > div .btn {
        width: 48%;
        margin-bottom: 5px;
    }
    
    .button-group .btn {
        flex: 1;
        min-width: 100px;
    }
}

/* Cải tiến responsive cho màn hình nhỏ (mobile) */
@media (max-width: 768px) {
    .fixed-header {
        padding: 8px 15px;
        height: auto;
        min-height: 50px;
        flex-direction: column;
        gap: 10px;
    }
    
    .fixed-header h2 {
        font-size: 1rem;
        text-align: center;
    }
    
    .fixed-header > div {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
        align-items: center;
    }
    
    .fixed-header .logout-btn {
        padding: 6px 12px;
        font-size: 0.85rem;
        width: 100%;
        max-width: 120px;
    }
    
    .container {
        padding: 10px;
        margin-top: 80px;
    }
    
    .card {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .stat-card {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .stat-card h3 {
        font-size: 1.5rem;
        margin-bottom: 8px;
    }
    
    .stat-card p {
        font-size: 0.8rem;
    }
    
    .row {
        flex-direction: column;
        margin-left: 0;
        margin-right: 0;
    }
    
    .col-md-8, .col-md-4 {
        width: 100%;
        max-width: 100%;
        padding: 0;
    }
    
    .header .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .header .d-flex > div {
        margin-top: 15px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    #chuHuiSelector {
        width: 100% !important;
        margin-bottom: 10px;
    }
    
    .header .d-flex > div .btn {
        width: 100%;
        margin-bottom: 0;
    }
    
    .button-group {
        flex-direction: column;
        gap: 8px;
    }
    
    .button-group .btn {
        width: 100%;
        margin-bottom: 0;
    }
    
    .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
    }
    
    .modal-content {
        padding: 15px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    /* Form improvements for mobile */
    .form-label {
        font-size: 0.9rem;
        margin-bottom: 6px;
    }
    
    .form-control {
        font-size: 0.9rem;
        padding: 8px 12px;
    }
    
    .btn {
        font-size: 0.85rem;
        padding: 8px 12px;
    }
    
    /* Card header improvements */
    .card-header {
        padding: 12px 15px;
        font-size: 0.9rem;
    }
    
    /* List group improvements for mobile */
    .list-group-item {
        padding: 10px 12px;
        font-size: 0.85rem;
    }
    
    /* Statistics improvements */
    .card-body .d-flex {
        padding: 6px 0;
        font-size: 0.9rem;
    }
}

/* Cải tiến responsive cho màn hình rất nhỏ */
@media (max-width: 480px) {
    .fixed-header {
        padding: 6px 10px;
        min-height: 45px;
    }
    
    .fixed-header h2 {
        font-size: 0.9rem;
    }
    
    .fixed-header > div {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }
    
    .fixed-header .me-3 {
        margin-right: 0 !important;
        margin-bottom: 0;
        font-size: 0.8rem;
        text-align: center;
    }
    
    .container {
        padding: 8px;
        margin-top: 70px;
    }
    
    .card {
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .stat-card {
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .stat-card h3 {
        font-size: 1.3rem;
    }
    
    .card-header {
        padding: 10px 12px;
        font-size: 0.85rem;
    }
    
    .form-label {
        font-size: 0.85rem;
    }
    
    .form-control {
        font-size: 0.85rem;
        padding: 6px 10px;
    }
    
    .btn {
        font-size: 0.8rem;
        padding: 6px 10px;
    }
    
    .list-group-item {
        padding: 8px 10px;
        font-size: 0.8rem;
    }
    
    .modal-dialog {
        margin: 5px;
        max-width: calc(100% - 10px);
    }
    
    .modal-content {
        padding: 10px;
    }
    
    .modal-body {
        padding: 10px;
    }
    
    .modal-footer {
        padding: 10px 0;
    }
    
    .modal-footer .btn {
        flex: 1;
        margin: 0 5px;
    }
    
    /* Login prompt improvements */
    .login-prompt {
        padding: 30px 15px;
    }
    
    .login-prompt h3 {
        font-size: 1.2rem;
    }
    
    .login-prompt p {
        font-size: 0.9rem;
    }
}

/* Cải tiến cho màn hình lớn */
@media (min-width: 1200px) {
    .container {
        max-width: 1400px;
    }
    
    .row {
        display: flex;
        flex-wrap: wrap;
        margin-left: -15px;
        margin-right: -15px;
    }
    
    .col-md-8 {
        flex: 0 0 66.666667%;
        max-width: 66.666667%;
        padding: 0 15px;
    }
    
    .col-md-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
        padding: 0 15px;
    }
    
    .header .d-flex {
        align-items: center !important;
    }
    
    .header .d-flex > div {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    #chuHuiSelector {
        width: auto !important;
        min-width: 200px;
    }
}

/* Animation improvements */
.card, .stat-card {
    transition: all 0.3s ease;
}

.btn {
    transition: all 0.3s ease;
}

/* Focus states for accessibility */
.btn:focus,
.form-control:focus,
.form-select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
}

/* Loading state improvements */
.d-none {
    display: none !important;
}

/* Text alignment improvements */
.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d !important;
}

/* Ensure proper spacing */
.mb-3 {
    margin-bottom: 1rem !important;
}

.mb-4 {
    margin-bottom: 1.5rem !important;
}

.mt-4 {
    margin-top: 1.5rem !important;
}

.me-2 {
    margin-right: 0.5rem !important;
}

.me-3 {
    margin-right: 1rem !important;
}
    </style>
</head>
<body>
    <!-- Thanh header cố định -->
    <div class="fixed-header" id="appHeader" style="display: none;">
        <h2><i class="fas fa-user-tie"></i> Thông Tin Chủ Hụi</h2>
        <div>
            <span class="me-3">Xin chào, <span id="userEmail"></span></span>
            <button class="logout-btn" onclick="signOut()">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
        </div>
    </div>

    <div class="container">
        <a href="dashboard.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Quay lại Dashboard
        </a>
        
        <div id="loginPrompt" class="login-prompt card">
            <div class="card-body">
                <h3>Vui lòng đăng nhập</h3>
                <p>Bạn cần đăng nhập để xem thông tin chủ hụi.</p>
                <button class="btn btn-primary" id="loginBtn">Đăng nhập</button>
            </div>
        </div>
        
        <div id="mainContent" class="d-none">
            <div class="header mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-user-tie"></i> Thông Tin Chủ Hụi</h2>
                    <div>
                        <select class="form-select d-inline-block w-auto me-2" id="chuHuiSelector">
                            <option value="">Chọn chủ hụi</option>
                        </select>
                        <button class="btn btn-primary" id="editBtn">
                            <i class="fas fa-edit"></i> Chỉnh sửa
                        </button>
                        <button class="btn btn-success" id="addChuHuiBtn">
                            <i class="fas fa-plus"></i> Thêm chủ hụi
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            Thông tin cơ bản
                        </div>
                        <div class="card-body">
                            <form id="chuhuiForm">
                                <input type="hidden" id="chuHuiId">
                                <div class="mb-3">
                                    <label for="tenChuHui" class="form-label">Tên chủ hụi</label>
                                    <input type="text" class="form-control" id="tenChuHui" value="" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="tenChuTK" class="form-label">Tên chủ tài khoản</label>
                                    <input type="text" class="form-control" id="tenChuTK" value="" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="soDienThoai" class="form-label">Số điện thoại</label>
                                    <input type="text" class="form-control" id="soDienThoai" value="" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="tenNganHang" class="form-label">Tên ngân hàng</label>
                                    <input type="text" class="form-control" id="tenNganHang" value="" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="soTaiKhoan" class="form-label">Số tài khoản</label>
                                    <input type="text" class="form-control" id="soTaiKhoan" value="" readonly>
                                </div>
                                <div class="button-group">
                                    <button type="submit" class="btn btn-primary d-none" id="saveBtn">Lưu thay đổi</button>
                                    <button type="button" class="btn btn-secondary d-none" id="cancelBtn">Hủy</button>
                                    <button type="button" class="btn btn-danger d-none" id="deleteBtn">Xóa chủ hụi</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            Thống kê
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <span>Tổng dây hụi quản lý:</span>
                                <strong id="tongDayHui">0</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Tổng hội viên:</span>
                                <strong id="tongHoiVien">0</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Tổng tiền hụi:</span>
                                <strong id="tongTienHui">0đ</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Hụi đang hoạt động:</span>
                                <strong id="huiDangHoatDong">0</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            Lịch sử thay đổi
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush" id="lichSuThayDoi">
                                <li class="list-group-item text-center">
                                    <small class="text-muted">Chưa có lịch sử thay đổi</small>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal thêm chủ hụi -->
    <div class="modal fade" id="addChuHuiModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm chủ hụi mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addChuHuiForm">
                        <div class="mb-3">
                            <label for="newTenChuHui" class="form-label">Tên chủ hụi *</label>
                            <input type="text" class="form-control" id="newTenChuHui" required>
                        </div>
                        <div class="mb-3">
                            <label for="newTenChuTK" class="form-label">Tên chủ tài khoản *</label>
                            <input type="text" class="form-control" id="newTenChuTK" required>
                        </div>
                        <div class="mb-3">
                            <label for="newSoDienThoai" class="form-label">Số điện thoại *</label>
                            <input type="text" class="form-control" id="newSoDienThoai" required>
                        </div>
                        <div class="mb-3">
                            <label for="newTenNganHang" class="form-label">Tên ngân hàng *</label>
                            <input type="text" class="form-control" id="newTenNganHang" required>
                        </div>
                        <div class="mb-3">
                            <label for="newSoTaiKhoan" class="form-label">Số tài khoản *</label>
                            <input type="text" class="form-control" id="newSoTaiKhoan" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveNewChuHuiBtn">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Khởi tạo Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCYV8na-Az2LAgpl6QM2Tiwr6Gm9yhXQZ0",
            authDomain: "quan-ly-hui-8ad1c.firebaseapp.com",
            databaseURL: "https://quan-ly-hui-8ad1c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quan-ly-hui-8ad1c",
            storageBucket: "quan-ly-hui-8ad1c.firebasestorage.app",
            messagingSenderId: "665511229865",
            appId: "1:665511229865:web:fe44f814fff618e35e6cb8"
        };
        
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        let currentUser = null;
        let addChuHuiModal = null;

        // Khởi tạo modal khi DOM loaded
        document.addEventListener('DOMContentLoaded', function() {
            addChuHuiModal = new bootstrap.Modal(document.getElementById('addChuHuiModal'));
        });
        
        // Xử lý đăng nhập
        document.getElementById('loginBtn').addEventListener('click', function() {
            // Sử dụng đăng nhập ẩn danh để demo
            auth.signInAnonymously()
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    showMainContent();
                    loadChuHuiList();
                })
                .catch((error) => {
                    console.error('Lỗi đăng nhập:', error);
                    alert('Có lỗi xảy ra khi đăng nhập. Vui lòng thử lại!');
                });
        });
        
        // Kiểm tra trạng thái đăng nhập
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                showMainContent();
                loadChuHuiList();
            } else {
                showLoginPrompt();
            }
        });
        
        function showLoginPrompt() {
            document.getElementById('loginPrompt').classList.remove('d-none');
            document.getElementById('mainContent').classList.add('d-none');
            document.getElementById('appHeader').style.display = 'none';
        }
        
        function showMainContent() {
            document.getElementById('loginPrompt').classList.add('d-none');
            document.getElementById('mainContent').classList.remove('d-none');
            document.getElementById('appHeader').style.display = 'flex';
        }
        
        // Tải danh sách chủ hụi
        function loadChuHuiList() {
            if (!currentUser) return;
            
            database.ref(`users/${currentUser.uid}/chuhui`).once('value').then(snapshot => {
                const data = snapshot.val();
                const selector = document.getElementById('chuHuiSelector');
                selector.innerHTML = '<option value="">Chọn chủ hụi</option>';
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = data[key].tenChuHui || 'Chủ hụi không tên';
                        selector.appendChild(option);
                    });
                }
            }).catch(error => {
                console.error('Lỗi khi tải danh sách chủ hụi:', error);
            });
        }
        
        // Xử lý chọn chủ hụi
        document.getElementById('chuHuiSelector').addEventListener('change', function() {
            const chuHuiId = this.value;
            if (chuHuiId) {
                loadChuHuiData(chuHuiId);
                document.getElementById('deleteBtn').classList.remove('d-none');
            } else {
                clearForm();
                document.getElementById('deleteBtn').classList.add('d-none');
            }
        });
        
        // Tải dữ liệu chủ hụi từ Firebase
        function loadChuHuiData(chuHuiId) {
            if (!currentUser) return;
            
            database.ref(`users/${currentUser.uid}/chuhui/${chuHuiId}`).once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('chuHuiId').value = chuHuiId;
                    document.getElementById('tenChuHui').value = data.tenChuHui || '';
                    document.getElementById('tenChuTK').value = data.tenChuTK || '';
                    document.getElementById('soDienThoai').value = data.soDienThoai || '';
                    document.getElementById('tenNganHang').value = data.tenNganHang || '';
                    document.getElementById('soTaiKhoan').value = data.soTaiKhoan || '';
                    
                    // Đảm bảo các trường ở chế độ readonly
                    setFormReadonly(true);
                    
                    // Cập nhật thống kê
                    updateStatistics(chuHuiId);
                    
                    // Cập nhật lịch sử thay đổi
                    updateLichSuThayDoi(data.lichSuThayDoi);
                }
            }).catch(error => {
                console.error('Lỗi khi tải dữ liệu chủ hụi:', error);
            });
        }
        
        // Đặt trạng thái readonly cho form
        function setFormReadonly(isReadonly) {
            const inputs = document.querySelectorAll('#chuhuiForm input:not([type="hidden"])');
            inputs.forEach(input => {
                if (isReadonly) {
                    input.setAttribute('readonly', 'readonly');
                } else {
                    input.removeAttribute('readonly');
                }
            });
        }
        
        // Cập nhật thống kê
        function updateStatistics(chuHuiId) {
            if (!currentUser) return;
            
            // Đếm số dây hụi
            database.ref(`users/${currentUser.uid}/dayhui`).once('value').then(snapshot => {
                const dayhuiData = snapshot.val();
                let tongDayHui = 0;
                let tongHoiVien = 0;
                let huiDangHoatDong = 0;
                
                if (dayhuiData) {
                    Object.keys(dayhuiData).forEach(key => {
                        const dayhui = dayhuiData[key];
                        if (dayhui.chuHuiId === chuHuiId) {
                            tongDayHui++;
                            
                            // Đếm hội viên
                            if (dayhui.hoiVien) {
                                tongHoiVien += Object.keys(dayhui.hoiVien).length;
                            }
                            
                            // Giả sử có trường trangThai để xác định hụi đang hoạt động
                            if (dayhui.trangThai === 'dang_hoat_dong') {
                                huiDangHoatDong++;
                            }
                        }
                    });
                }
                
                document.getElementById('tongDayHui').textContent = tongDayHui;
                document.getElementById('tongHoiVien').textContent = tongHoiVien;
                document.getElementById('huiDangHoatDong').textContent = huiDangHoatDong;
                
                // Tính tổng tiền hụi (giả sử mỗi dây hụi có tongTien)
                document.getElementById('tongTienHui').textContent = '0đ';
            }).catch(error => {
                console.error('Lỗi khi cập nhật thống kê:', error);
            });
        }
        
        // Cập nhật lịch sử thay đổi
        function updateLichSuThayDoi(lichSu) {
            const list = document.getElementById('lichSuThayDoi');
            list.innerHTML = '';
            
            if (lichSu && Object.keys(lichSu).length > 0) {
                // Sắp xếp theo thời gian (mới nhất lên đầu)
                const sortedKeys = Object.keys(lichSu).sort((a, b) => b - a);
                
                sortedKeys.forEach(key => {
                    const item = lichSu[key];
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div>
                            <small>${item.noiDung}</small>
                            <div><small class="text-muted">${item.thoiGian}</small></div>
                        </div>
                    `;
                    list.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'list-group-item text-center';
                li.innerHTML = '<small class="text-muted">Chưa có lịch sử thay đổi</small>';
                list.appendChild(li);
            }
        }
        
        // Xóa form
        function clearForm() {
            document.getElementById('chuHuiId').value = '';
            document.getElementById('tenChuHui').value = '';
            document.getElementById('tenChuTK').value = '';
            document.getElementById('soDienThoai').value = '';
            document.getElementById('tenNganHang').value = '';
            document.getElementById('soTaiKhoan').value = '';
            
            document.getElementById('tongDayHui').textContent = '0';
            document.getElementById('tongHoiVien').textContent = '0';
            document.getElementById('tongTienHui').textContent = '0đ';
            document.getElementById('huiDangHoatDong').textContent = '0';
            
            updateLichSuThayDoi(null);
        }
        
        // Xử lý chỉnh sửa thông tin
        document.getElementById('editBtn').addEventListener('click', function() {
            const chuHuiId = document.getElementById('chuHuiId').value;
            if (!chuHuiId) {
                alert('Vui lòng chọn một chủ hụi để chỉnh sửa');
                return;
            }
            
            // Cho phép chỉnh sửa
            setFormReadonly(false);
            
            // Hiển thị nút lưu/hủy, ẩn nút chỉnh sửa
            document.getElementById('saveBtn').classList.remove('d-none');
            document.getElementById('cancelBtn').classList.remove('d-none');
            document.getElementById('editBtn').classList.add('d-none');
        });
        
        document.getElementById('cancelBtn').addEventListener('click', function() {
            const chuHuiId = document.getElementById('chuHuiId').value;
            if (chuHuiId) {
                // Tải lại dữ liệu từ Firebase để khôi phục
                loadChuHuiData(chuHuiId);
            } else {
                clearForm();
            }
            
            // Ẩn nút lưu/hủy, hiển thị nút chỉnh sửa
            document.getElementById('saveBtn').classList.add('d-none');
            document.getElementById('cancelBtn').classList.add('d-none');
            document.getElementById('editBtn').classList.remove('d-none');
        });
        
        document.getElementById('chuhuiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const chuHuiId = document.getElementById('chuHuiId').value;
            if (!chuHuiId) {
                alert('Không tìm thấy ID chủ hụi');
                return;
            }
            
            // Lấy dữ liệu từ form
            const chuhuiData = {
                tenChuHui: document.getElementById('tenChuHui').value,
                tenChuTK: document.getElementById('tenChuTK').value,
                soDienThoai: document.getElementById('soDienThoai').value,
                tenNganHang: document.getElementById('tenNganHang').value,
                soTaiKhoan: document.getElementById('soTaiKhoan').value
            };
            
            // Thêm lịch sử thay đổi
            const currentTime = new Date().toLocaleString('vi-VN');
            const changeId = new Date().getTime().toString();
            
            database.ref(`users/${currentUser.uid}/chuhui/${chuHuiId}/lichSuThayDoi/${changeId}`).set({
                noiDung: 'Cập nhật thông tin chủ hụi',
                thoiGian: currentTime
            });
            
            // Lưu dữ liệu lên Firebase
            database.ref(`users/${currentUser.uid}/chuhui/${chuHuiId}`).update(chuhuiData)
                .then(() => {
                    alert('Thông tin chủ hụi đã được cập nhật thành công!');
                    
                    // Khóa form lại
                    setFormReadonly(true);
                    
                    // Ẩn nút lưu/hủy, hiển thị nút chỉnh sửa
                    document.getElementById('saveBtn').classList.add('d-none');
                    document.getElementById('cancelBtn').classList.add('d-none');
                    document.getElementById('editBtn').classList.remove('d-none');
                    
                    // Cập nhật danh sách
                    loadChuHuiList();
                })
                .catch(error => {
                    console.error('Lỗi khi lưu thông tin chủ hụi:', error);
                    alert('Có lỗi xảy ra khi lưu thông tin. Vui lòng thử lại!');
                });
        });
        
        // Xử lý xóa chủ hụi
        document.getElementById('deleteBtn').addEventListener('click', function() {
            const chuHuiId = document.getElementById('chuHuiId').value;
            if (!chuHuiId) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa chủ hụi này? Hành động này không thể hoàn tác.')) {
                database.ref(`users/${currentUser.uid}/chuhui/${chuHuiId}`).remove()
                    .then(() => {
                        alert('Chủ hụi đã được xóa thành công!');
                        clearForm();
                        loadChuHuiList();
                        document.getElementById('chuHuiSelector').value = '';
                    })
                    .catch(error => {
                        console.error('Lỗi khi xóa chủ hụi:', error);
                        alert('Có lỗi xảy ra khi xóa chủ hụi. Vui lòng thử lại!');
                    });
            }
        });
        
        // Xử lý thêm chủ hụi mới
        document.getElementById('addChuHuiBtn').addEventListener('click', function() {
            // Reset form trước khi hiển thị
            document.getElementById('addChuHuiForm').reset();
            addChuHuiModal.show();
        });
        
        document.getElementById('saveNewChuHuiBtn').addEventListener('click', function() {
            const form = document.getElementById('addChuHuiForm');
            
            // Kiểm tra validation
            if (!form.checkValidity()) {
                // Hiển thị thông báo validation
                form.classList.add('was-validated');
                return;
            }
            
            const newChuHuiData = {
                tenChuHui: document.getElementById('newTenChuHui').value,
                tenChuTK: document.getElementById('newTenChuTK').value,
                soDienThoai: document.getElementById('newSoDienThoai').value,
                tenNganHang: document.getElementById('newTenNganHang').value,
                soTaiKhoan: document.getElementById('newSoTaiKhoan').value,
                ngayTao: new Date().toISOString()
            };
            
            const newKey = database.ref().child(`users/${currentUser.uid}/chuhui`).push().key;
            
            database.ref(`users/${currentUser.uid}/chuhui/${newKey}`).set(newChuHuiData)
                .then(() => {
                    alert('Thêm chủ hụi mới thành công!');
                    addChuHuiModal.hide();
                    loadChuHuiList();
                    
                    // Tự động chọn chủ hụi mới
                    setTimeout(() => {
                        document.getElementById('chuHuiSelector').value = newKey;
                        loadChuHuiData(newKey);
                    }, 500);
                })
                .catch(error => {
                    console.error('Lỗi khi thêm chủ hụi mới:', error);
                    alert('Có lỗi xảy ra khi thêm chủ hụi mới. Vui lòng thử lại!');
                });
        });
        
        // Hàm đăng xuất
        function signOut() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                auth.signOut();
            }
        }
    </script>
</body>
</html>
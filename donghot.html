<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê√≥ng H·ªët H·ª•i - Qu·∫£n L√Ω H·ª•i</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 0;
        }

        /* Thanh header c·ªë ƒë·ªãnh */
        .fixed-header {
            background-color: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            height: 60px;
        }

        .fixed-header h2 {
            font-size: 1.3rem;
            font-weight: normal;
        }

        .fixed-header .logout-btn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }

        .fixed-header .logout-btn:hover {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 60px;
        }
        
        .back-btn {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 20px;
            display: inline-block;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .back-btn:hover {
            text-decoration: none;
            background-color: #f0f0f0;
        }
        
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            background: white;
        }
        
        .card-header {
            background-color: #34495e;
            color: white;
            border-radius: 8px 8px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: #3498db;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            border: none;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-info {
            background-color: #17a2b8;
            border: none;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .calculation-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .calculation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calculation-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
            color: #3498db;
        }
        
        .loss {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .profit {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .member-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }
        
        .member-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .member-item:hover {
            background-color: #f8f9fa;
        }
        
        .member-item.selected {
            background-color: #3498db;
            color: white;
        }
        
        .member-item:last-child {
            border-bottom: none;
        }
        
        /* CSS cho b·∫£ng danh s√°ch h·ªôi vi√™n */
        .member-table-container {
            margin-top: 30px;
            overflow-x: auto;
        }
        
        .member-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .member-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .member-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .member-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .member-table tr:hover {
            background-color: #e9ecef;
        }
        
        .member-table .stt-col {
            width: 50px;
        }
        
        .member-table .name-col {
            text-align: left;
            min-width: 150px;
        }
        
        .member-table .total-col {
            font-weight: bold;
            color: #3498db;
            min-width: 120px;
        }
        
        .member-table .period-col {
            min-width: 100px;
        }
        
        .member-table .period-header {
            background-color: #3498db;
        }
        
        .empty-cell {
            color: #aaa;
            font-style: italic;
        }
        
        .paid-amount {
            color: #2ecc71;
            font-weight: 500;
        }
        
        .not-paid {
            color: #e74c3c;
            font-weight: 500;
        }
        
        .tham-keu-row {
            background-color: #f0f8ff !important;
            font-weight: 500;
        }
        
        .tham-keu-row td {
            border-bottom: 2px solid #3498db;
        }
        
        .badge {
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .hot-amount {
            color: #3498db;
            font-weight: bold;
        }

        /* CSS cho modal th√¥ng tin d√¢y h·ª•i */
        .hui-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .hui-info-table th {
            background-color: #f8f9fa;
            text-align: left;
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            font-weight: 600;
            width: 30%;
        }
        
        .hui-info-table td {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
        }
        
        .member-list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .member-list-table th {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .member-list-table td {
            padding: 8px 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .member-list-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        /* Responsive cho tablet */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
            }
        }
        
        /* Responsive cho m√†n h√¨nh nh·ªè (mobile) */
        @media (max-width: 768px) {
            .fixed-header {
                padding: 8px 15px;
                height: 50px;
            }
            .fixed-header h2 {
                font-size: 1rem;
            }
            
            .fixed-header .logout-btn {
                padding: 4px 8px;
                font-size: 0.85rem;
            }
            
            .container {
                padding: 10px;
                margin-top: 50px;
            }
            
            .card-header {
                padding: 12px 15px;
            }
            
            .calculation-section {
                padding: 15px;
            }
        }

        /* Responsive cho m√†n h√¨nh r·∫•t nh·ªè */
        @media (max-width: 480px) {
            .fixed-header {
                padding: 6px 10px;
                height: 45px;
            }
            
            .fixed-header h2 {
                font-size: 0.9rem;
            }
            
            .container {
                padding: 8px;
                margin-top: 45px;
            }
            
            .card-header {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .calculation-section {
                padding: 12px;
            }
            
            .calculation-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .calculation-item span:last-child {
                margin-top: 5px;
                align-self: flex-end;
            }
        }
        .hui-info-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            text-align: center;
        }
        
        .hui-info-header h4 {
            margin: 0;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .hui-info-header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .info-value {
            color: #e74c3c;
            font-weight: 500;
        }
        
        .member-table-modal {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        
        .member-table-modal th {
            background-color: #2c3e50;
            color: white;
            padding: 8px 5px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-weight: 600;
        }
        
        .member-table-modal td {
            padding: 6px 5px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .member-table-modal tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .stt-col {
            width: 40px;
        }
        
        .name-col {
            text-align: left;
            min-width: 120px;
        }
        
        .phone-col, .address-col, .chan-col, .ky-col {
            width: 80px;
        }
        
        .thamhot-col, .tiendong-col, .tienhot-col {
            width: 100px;
        }
        
        /* C√°c c·ªôt m·ªõi */
        .ky-hot-col {
            width: 80px;
        }
        
        .tham-keu-col {
            width: 100px;
        }
        
        .tien-dong-col {
            width: 120px;
        }
        
        .tien-hot-col {
            width: 120px;
        }
        .member-table .ky-period-col {
            min-width: 100px;
            background-color: #f8f9fa;
        }
        
        .member-table .ky-period-header {
            background-color: #3498db;
        }
        
        .paid-cell {
            color: #2ecc71;
            font-weight: 500;
        }
        
        .hot-cell {
            color: #3498db;
            font-weight: bold;
            background-color: #f0f8ff;
        }
        
        .not-paid-cell {
            color: #e74c3c;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Thanh header c·ªë ƒë·ªãnh -->
    <div class="fixed-header">
        <h2><i class="fas fa-money-bill-wave"></i> ƒê√≥ng H·ªët H·ª•i</h2>
        <div>
            <span class="me-3">Xin ch√†o, <span id="userEmail"></span></span>
            <button class="logout-btn" onclick="signOut()">
                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="dashboard.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Quay l·∫°i Danh s√°ch d√¢y h·ª•i
            </a>
            
            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#huiInfoModal">
                <i class="fas fa-info-circle"></i> Th√¥ng tin d√¢y h·ª•i
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                Th√¥ng tin h·ªët h·ª•i - <span id="huiNameDisplay">[T√™n d√¢y h·ª•i]</span>
            </div>
            <div class="card-body">
                <form id="hotHuiForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">K·ª≥ h·ªët h·ª•i *</label>
                                <input type="number" class="form-control" id="kyHot" 
                                       min="1" required placeholder="Nh·∫≠p k·ª≥ h·ªët" onchange="calculateTotals()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Ng√†y h·ªët *</label>
                                <input type="date" class="form-control" id="ngayHot" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Gi·ªù h·ªët *</label>
                                <input type="time" class="form-control" id="gioHot" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">ThƒÉm k√™u (s·ªë ti·ªÅn b·ªè) *</label>
                                <input type="number" class="form-control" id="thamKeu" 
                                       min="0" required value="0" onchange="calculateTotals()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Tr·ª´ ti·ªÅn kh√°c</label>
                                <input type="number" class="form-control" id="truTienKhac" 
                                       min="0" value="0" onchange="calculateTotals()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Ng∆∞·ªùi h·ªët *</label>
                                <select class="form-select" id="nguoiHot" required>
                                    <option value="">Ch·ªçn ng∆∞·ªùi h·ªët</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Th√¥ng tin d√¢y h·ª•i -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ti·ªÅn h·ª•i</label>
                                <input type="text" class="form-control" id="tienHuiDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ti·ªÅn th·∫£o</label>
                                <input type="text" class="form-control" id="tienThaoDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">S·ªë k·ª≥ c√≤n l·∫°i</label>
                                <input type="text" class="form-control" id="soKyConLaiDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">S·ªë ch√¢n</label>
                                <input type="text" class="form-control" id="soChanDisplay" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- T√≠nh to√°n -->
                    <div class="calculation-section">
                        <h5><i class="fas fa-calculator"></i> T√≠nh to√°n h·ªët h·ª•i</h5>
                        
                        <div class="calculation-item">
                            <span>S·ªë ch√¢n s·ªëng:</span>
                            <span id="soChanSongDisplay">0 ch√¢n</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>Ti·ªÅn h·ª•i sau th·∫£o:</span>
                            <span id="tienHuiSauThaoDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>S·ªë ch√¢n s·ªëng √ó Ti·ªÅn h·ª•i sau th·∫£o:</span>
                            <span id="chanSongTienHuiDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>S·ªë ch√¢n ch·∫øt:</span>
                            <span id="soChanChetDisplay">0 ch√¢n</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>S·ªë ch√¢n ch·∫øt √ó Ti·ªÅn h·ª•i:</span>
                            <span id="chanChetTienHuiDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>Tr·ª´ ti·ªÅn kh√°c:</span>
                            <span id="truTienKhacDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>T·ªïng s·ªë ti·ªÅn h·ªët:</span>
                            <span id="tongTienHotDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>L·ªùi/L·ªó:</span>
                            <span id="loiLoDisplay" class="profit">0ƒë</span>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="button" class="btn btn-success flex-fill" onclick="confirmHot()">
                            <i class="fas fa-check-circle"></i> X√°c nh·∫≠n h·ªët
                        </button>
                        <button type="button" class="btn btn-secondary flex-fill" onclick="cancelHot()">
                            <i class="fas fa-times-circle"></i> Hu·ª∑
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- B·∫£ng danh s√°ch h·ªôi vi√™n -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-users"></i> Danh s√°ch h·ªôi vi√™n v√† l·ªãch s·ª≠ ƒë√≥ng h·ª•i
            </div>
            <div class="card-body">
                <div class="member-table-container">
                    <table class="member-table" id="memberTable">
                        <thead>
                            <tr>
                                <th class="stt-col">STT</th>
                                <th class="name-col">H·ªôi vi√™n</th>
                                <th class="ky-hot-col">K·ª≥ h·ªët</th>
                                <th class="tham-keu-col">ThƒÉm k√™u</th>
                                <th class="tien-dong-col">Ti·ªÅn ƒë√≥ng</th>
                                <th class="tien-hot-col">Ti·ªÅn h·ªët</th>
                                <!-- C√°c c·ªôt k·ª≥ s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông b·∫±ng JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                            <!-- D·ªØ li·ªáu h·ªôi vi√™n s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông b·∫±ng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Th√¥ng tin d√¢y h·ª•i -->
    <div class="modal fade" id="huiInfoModal" tabindex="-1" aria-labelledby="huiInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="hui-info-header">
                    <h4 class="modal-title" id="huiInfoModalLabel">Th√¥ng tin d√¢y h·ª•i</h4>
                    <div class="subtitle">Chi ti·∫øt d√¢y h·ª•i v√† danh s√°ch h·ªôi vi√™n</div>
                </div>
                <div class="modal-body">
                    <div id="huiInfoContent">
                        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYV8na-Az2LAgpl6QM2Tiwr6Gm9yhXQZ0",
            authDomain: "quan-ly-hui-8ad1c.firebaseapp.com",
            databaseURL: "https://quan-ly-hui-8ad1c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quan-ly-hui-8ad1c",
            storageBucket: "quan-ly-hui-8ad1c.firebasestorage.app",
            messagingSenderId: "665511229865",
            appId: "1:665511229865:web:fe44f814fff618e35e6cb8"
        };

        let database;
        let auth;
        let currentUser = null;
        let currentHui = null;
        let currentHuiId = null;

        // Kh·ªüi t·∫°o Firebase
        function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK ch∆∞a ƒë∆∞·ª£c t·∫£i');
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                auth = firebase.auth();
                console.log('‚úÖ Firebase ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng');
                return true;
            } catch (error) {
                console.error('‚ùå L·ªói kh·ªüi t·∫°o Firebase:', error);
                return false;
            }
        }

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('‚úÖ Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p:', user.uid, user.email);
                    document.getElementById('userEmail').textContent = user.email;
                    loadHuiData();
                } else {
                    currentUser = null;
                    window.location.href = 'dayhui.html';
                }
            });
        }

        // L·∫•y d·ªØ li·ªáu d√¢y h·ª•i t·ª´ URL parameter
        function getHuiIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('huiId');
        }

        // H√†m s·ª≠a l·ªói t·ª± ƒë·ªông t·∫•t c·∫£ c√°c tr∆∞·ªùng b·ªã sai
        async function fixAllDataFieldNames() {
            try {
                const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot`);
                const snapshot = await hotRef.once('value');
                
                if (!snapshot.exists()) return;
                
                const updates = {};
                const listHot = snapshot.val();
                
                for (const kyHot in listHot) {
                    const hot = listHot[kyHot];
                    
                    // Mapping c√°c tr∆∞·ªùng sai sang tr∆∞·ªùng ƒë√∫ng
                    const fieldMappings = {
                        'kyliot': 'kyHot',
                        'lollo': 'loiLo', 
                        'ngayliot': 'ngayHot',
                        'nguolilot': 'nguoiHot',
                        'nguolilotTen': 'nguoiHotTen',
                        'nguoIHot': 'nguoiHot',
                        'nguoIHotTen': 'nguoiHotTen',
                        'thanKeu': 'thamKeu',
                        'truTienKhao': 'truTienKhac'
                    };
                    
                    for (const [wrongField, correctField] of Object.entries(fieldMappings)) {
                        if (hot[wrongField] !== undefined && hot[wrongField] !== null) {
                            updates[`${kyHot}/${correctField}`] = hot[wrongField];
                            updates[`${kyHot}/${wrongField}`] = null; // X√≥a tr∆∞·ªùng sai
                        }
                    }
                }
                
                if (Object.keys(updates).length > 0) {
                    await hotRef.update(updates);
                    console.log('‚úÖ ƒê√£ s·ª≠a t·ª± ƒë·ªông t·∫•t c·∫£ c√°c t√™n tr∆∞·ªùng sai');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('‚ùå L·ªói khi s·ª≠a t√™n tr∆∞·ªùng:', error);
                return false;
            }
        }

        // H√†m chu·∫©n h√≥a d·ªØ li·ªáu h·ªët h·ª•i
        function normalizeHotData(hotData, kyHot) {
            return {
                kyHot: hotData.kyHot || hotData.kyliot || parseInt(kyHot),
                nguoiHot: hotData.nguoiHot || hotData.nguolilot || hotData.nguoIHot || hotData.nguoHot,
                nguoiHotTen: hotData.nguoiHotTen || hotData.nguolilotTen || hotData.nguoIHotTen || hotData.nguoHotTen,
                thamKeu: hotData.thamKeu || hotData.thanKeu || hotData.thanKau || 0,
                ngayHot: hotData.ngayHot || hotData.ngayliot || new Date().toISOString().split('T')[0],
                gioHot: hotData.gioHot || '00:00',
                truTienKhac: hotData.truTienKhac || hotData.truTienKhao || hotData.truTienKhae || 0,
                tongTienHot: hotData.tongTienHot || 0,
                loiLo: hotData.loiLo || hotData.lollo || hotData.Ioilo || 0,
                ngayTao: hotData.ngayTao || new Date().toISOString()
            };
        }

        // T·∫£i d·ªØ li·ªáu d√¢y h·ª•i
        async function loadHuiData() {
            const huiId = getHuiIdFromURL();
            if (!huiId) return;

            currentHuiId = huiId;

            try {
                const huiRef = database.ref('users/' + currentUser.uid + '/dayhui/' + huiId);
                const snapshot = await huiRef.once('value');
                if (!snapshot.exists()) return;

                currentHui = snapshot.val();

                // --- üîß T·ª± s·ª≠a l·ªói t√™n tr∆∞·ªùng sai n·∫øu c√≥ ---
                const hasFixed = await fixAllDataFieldNames();
                if (hasFixed) {
                    console.log('üîÑ Reload d·ªØ li·ªáu sau khi s·ª≠a l·ªói...');
                    const newSnapshot = await huiRef.once('value');
                    currentHui = newSnapshot.val();
                }

                // --- ‚úÖ Chuy·ªÉn danh s√°ch h·ªôi vi√™n t·ª´ object v·ªÅ array n·∫øu c·∫ßn ---
                if (currentHui.hoiVien && !Array.isArray(currentHui.hoiVien)) {
                    const tempHoiVien = [];
                    Object.keys(currentHui.hoiVien).forEach(key => {
                        tempHoiVien.push(currentHui.hoiVien[key]);
                    });
                    currentHui.hoiVien = tempHoiVien;
                    console.log('üìã ƒê√£ chuy·ªÉn h·ªôi vi√™n t·ª´ object ‚Üí array');
                }

                // --- üßæ Load l·ªãch s·ª≠ h·ªët ---
                const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${huiId}/lichSuHot`);
                const hotSnap = await hotRef.once('value');

                if (hotSnap.exists()) {
                    const listHot = hotSnap.val();
                    const hoiVienArray = Array.isArray(currentHui.hoiVien)
                        ? currentHui.hoiVien
                        : [];

                    for (const kyHot in listHot) {
                        const rawHotData = listHot[kyHot];
                        const hot = normalizeHotData(rawHotData, kyHot);

                        const hoiVienId = hot.nguoiHot;
                        if (!hoiVienId) {
                            console.warn('‚ö†Ô∏è Kh√¥ng c√≥ ID ng∆∞·ªùi h·ªët ·ªü k·ª≥', kyHot);
                            continue;
                        }

                        // --- üîç T√¨m h·ªôi vi√™n tr√πng ID ho·∫∑c tr√πng t√™n ---
                        let hoiVien = hoiVienArray.find(hv => hv.id === hoiVienId);

                        if (!hoiVien && hot.nguoiHotTen) {
                            hoiVien = hoiVienArray.find(hv => hv.ten === hot.nguoiHotTen.split(' ')[0]);
                        }

                        if (hoiVien) {
                            hoiVien.daHot = true;
                            hoiVien.kyDaHot = hot.kyHot;
                            hoiVien.ngayHot = hot.ngayHot;
                            hoiVien.thamKeu = hot.thamKeu;
                            console.log(`‚úÖ ${hoiVien.ten} ƒë√£ h·ªët k·ª≥ ${hot.kyHot}`);
                        } else {
                            console.warn(`‚ùå Kh√¥ng t√¨m th·∫•y h·ªôi vi√™n c√≥ ID ${hoiVienId} ou t√™n ${hot.nguoiHotTen}`);
                        }
                    }
                } else {
                    console.log('‚ÑπÔ∏è Ch∆∞a c√≥ l·ªãch s·ª≠ h·ªët h·ª•i.');
                }

                // --- Hi·ªÉn th·ªã th√¥ng tin v√† b·∫£ng ---
                displayHuiInfo();
                loadHoiVienList();
                setDefaultDateTime();
                loadMemberTable();

            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu d√¢y h·ª•i:', error);
            }
        }

        // Hi·ªÉn th·ªã th√¥ng tin d√¢y h·ª•i
        function displayHuiInfo() {
            if (!currentHui) return;

            document.getElementById('huiNameDisplay').textContent = currentHui.tendayhui || 'Ch∆∞a c√≥ t√™n';
            document.getElementById('tienHuiDisplay').value = formatCurrency(currentHui.tienHui || 0);
            document.getElementById('tienThaoDisplay').value = formatCurrency(currentHui.tienThao || 0);
            
            const soKyConLai = (currentHui.tongSoKy || 0) - (currentHui.soKy || 0);
            document.getElementById('soKyConLaiDisplay').value = soKyConLai + ' k·ª≥';
            
            // S·ª¨A L·∫†I: S·ª≠ d·ª•ng getHoiVienArray() ƒë·ªÉ l·∫•y s·ªë ch√¢n ch√≠nh x√°c
            const soHoiVien = getHoiVienArray().length;
            document.getElementById('soChanDisplay').value = soHoiVien + ' ch√¢n';

            calculateTotals();
        }

        // T·∫£i danh s√°ch h·ªôi vi√™n
        function loadHoiVienList() {
            if (!currentHui || !currentHui.hoiVien) return;

            const nguoiHotSelect = document.getElementById('nguoiHot');
            nguoiHotSelect.innerHTML = '<option value="">Ch·ªçn ng∆∞·ªùi h·ªët</option>';

            let hoiVienArray = getHoiVienArray();
            
            hoiVienArray.forEach(hoiVien => {
                if (hoiVien.trangThai === 'dang_tham_gia' && !hoiVien.daHot) {
                    const option = document.createElement('option');
                    option.value = hoiVien.id;
                    option.textContent = hoiVien.ten + ' (Ch√¢n ' + hoiVien.soChan + ')';
                    nguoiHotSelect.appendChild(option);
                }
            });
        }

        // H√†m l·∫•y danh s√°ch h·ªôi vi√™n d·∫°ng array
        function getHoiVienArray() {
            if (!currentHui || !currentHui.hoiVien) return [];

            // L·∫•y ra danh s√°ch h·ªôi vi√™n (d√π l√† object hay array)
            let hoiVienArray = Array.isArray(currentHui.hoiVien)
                ? currentHui.hoiVien
                : Object.keys(currentHui.hoiVien).map(key => ({
                    ...currentHui.hoiVien[key],
                    id: key
                }));

            // L·ªçc b·ªè ph·∫ßn t·ª≠ kh√¥ng c√≥ t√™n
            hoiVienArray = hoiVienArray.filter(hv => hv && hv.ten);

            // üß© L·ªçc tr√πng ID ho·∫∑c tr√πng t√™n + s·ªë ch√¢n
            const unique = [];
            const seen = new Set();
            for (const hv of hoiVienArray) {
                const key = hv.id || `${hv.ten}_${hv.soChan}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(hv);
                }
            }

            console.log('üìä S·ªë h·ªôi vi√™n th·ª±c t·∫ø:', unique.length, unique);
            return unique;
        }

        // ƒê·∫∑t ng√†y gi·ªù m·∫∑c ƒë·ªãnh
        function setDefaultDateTime() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const time = now.toTimeString().substring(0, 5);

            document.getElementById('ngayHot').value = today;
            document.getElementById('gioHot').value = time;
        }

        // T√≠nh to√°n t·ªïng ti·ªÅn
        function calculateTotals() {
            if (!currentHui) return;

            const tienHui = parseFloat(currentHui.tienHui) || 0;
            const tienThao = parseFloat(currentHui.tienThao) || 0;
            const thamKeu = parseFloat(document.getElementById('thamKeu').value) || 0;
            const truTienKhac = parseFloat(document.getElementById('truTienKhac').value) || 0;

            // S·ª¨A L·∫†I: S·ª≠ d·ª•ng getHoiVienArray() ƒë·ªÉ l·∫•y s·ªë ch√¢n ch√≠nh x√°c
            let hoiVienArray = getHoiVienArray();

            // T√≠nh s·ªë ch√¢n s·ªëng (ch∆∞a h·ªët) v√† ch·∫øt (ƒë√£ h·ªët)
            const soChanSong = hoiVienArray.filter(hv => 
                hv.trangThai === 'dang_tham_gia' && !hv.daHot
            ).length;
            
            const soChanChet = hoiVienArray.filter(hv => 
                hv.trangThai === 'dang_tham_gia' && hv.daHot
            ).length;

            // T√≠nh to√°n c√°c gi√° tr·ªã
            const tienHuiSauThao = tienHui - tienThao;
            const chanSongTienHui = soChanSong * tienHuiSauThao;
            const chanChetTienHui = soChanChet * tienHui;
            const tongTienHot = chanSongTienHui + chanChetTienHui - truTienKhac;
            const loiLo = tienHui*((soChanSong+soChanChet) - 1)- tongTienHot;

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            document.getElementById('soChanSongDisplay').textContent = soChanSong + ' ch√¢n';
            document.getElementById('soChanChetDisplay').textContent = soChanChet + ' ch√¢n';
            document.getElementById('tienHuiSauThaoDisplay').textContent = formatCurrency(tienHuiSauThao);
            document.getElementById('chanSongTienHuiDisplay').textContent = formatCurrency(chanSongTienHui);
            document.getElementById('chanChetTienHuiDisplay').textContent = formatCurrency(chanChetTienHui);
            document.getElementById('truTienKhacDisplay').textContent = formatCurrency(truTienKhac);
            document.getElementById('tongTienHotDisplay').textContent = formatCurrency(tongTienHot);
            
            const loiLoElement = document.getElementById('loiLoDisplay');
            loiLoElement.textContent = formatCurrency(loiLo);
            if (loiLo > 0) {
                loiLoElement.className = 'profit';
            } else if (loiLo < 0) {
                loiLoElement.className = 'loss';
            } else {
                loiLoElement.className = '';
            }
        }

        // X√°c nh·∫≠n h·ªët h·ª•i
        async function confirmHot() {
            if (!validateForm()) return;

            const kyHot = parseInt(document.getElementById('kyHot').value);
            const nguoiHot = document.getElementById('nguoiHot').value;
            const nguoiHotSelect = document.getElementById('nguoiHot');
            const nguoiHotTen = nguoiHotSelect.options[nguoiHotSelect.selectedIndex].text;
            const thamKeu = parseFloat(document.getElementById('thamKeu').value) || 0;
            const ngayHot = document.getElementById('ngayHot').value;
            const gioHot = document.getElementById('gioHot').value;
            const truTienKhac = parseFloat(document.getElementById('truTienKhac').value) || 0;
            
            // T√≠nh to√°n l·∫°i t·ªïng ti·ªÅn h·ªët
            const tienHui = parseFloat(currentHui.tienHui) || 0;
            const tienThao = parseFloat(currentHui.tienThao) || 0;
            const tienHuiSauThao = tienHui - tienThao;
            
            // S·ª¨A L·∫†I: S·ª≠ d·ª•ng getHoiVienArray() ƒë·ªÉ l·∫•y s·ªë ch√¢n ch√≠nh x√°c
            let hoiVienArray = getHoiVienArray();
            
            const soChanSong = hoiVienArray.filter(hv => 
                hv.trangThai === 'dang_tham_gia' && !hv.daHot
            ).length;
            
            const soChanChet = hoiVienArray.filter(hv => 
                hv.trangThai === 'dang_tham_gia' && hv.daHot
            ).length;
            
            const chanSongTienHui = soChanSong * tienHuiSauThao;
            const chanChetTienHui = soChanChet * tienHui;
            const tongTienHot = chanSongTienHui + chanChetTienHui - truTienKhac;
            const loiLo = tongTienHot - tienHui;

            try {
                // L∆∞u th√¥ng tin h·ªët h·ª•i
                const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot/${kyHot}`);
                const hotData = {
                    kyHot: kyHot,
                    nguoiHot: nguoiHot,
                    nguoiHotTen: nguoiHotTen,
                    thamKeu: thamKeu,
                    ngayHot: ngayHot,
                    gioHot: gioHot,
                    truTienKhac: truTienKhac,
                    tongTienHot: tongTienHot,
                    loiLo: loiLo,
                    ngayTao: new Date().toISOString()
                };

                await hotRef.set(hotData);
                console.log('‚úÖ ƒê√£ l∆∞u th√¥ng tin h·ªët h·ª•i:', hotData);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªët cho h·ªôi vi√™n
                const hoiVienRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/hoiVien`);
                const hoiVienSnapshot = await hoiVienRef.once('value');
                const hoiVienData = hoiVienSnapshot.val();
                
                let updatedHoiVienData = {};
                let found = false;
                
                // T√¨m h·ªôi vi√™n theo ID ho·∫∑c t√™n
                if (Array.isArray(hoiVienData)) {
                    hoiVienData.forEach((hoiVien, index) => {
                        if (hoiVien.id === nguoiHot || hoiVien.ten === nguoiHotTen.split(' ')[0]) {
                            updatedHoiVienData[index] = {
                                ...hoiVien,
                                daHot: true,
                                kyDaHot: kyHot,
                                ngayHot: ngayHot,
                                thamKeu: thamKeu
                            };
                            found = true;
                        } else {
                            updatedHoiVienData[index] = hoiVien;
                        }
                    });
                } else {
                    Object.keys(hoiVienData).forEach(key => {
                        const hoiVien = hoiVienData[key];
                        if (hoiVien.id === nguoiHot || hoiVien.ten === nguoiHotTen.split(' ')[0]) {
                            updatedHoiVienData[key] = {
                                ...hoiVien,
                                daHot: true,
                                kyDaHot: kyHot,
                                ngayHot: ngayHot,
                                thamKeu: thamKeu
                            };
                            found = true;
                        } else {
                            updatedHoiVienData[key] = hoiVien;
                        }
                    });
                }

                if (found) {
                    await hoiVienRef.set(updatedHoiVienData);
                    console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªët cho h·ªôi vi√™n');
                } else {
                    console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y h·ªôi vi√™n ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªët');
                }

                // C·∫≠p nh·∫≠t s·ªë k·ª≥
                const soKyHienTai = parseInt(currentHui.soKy) || 0;
                const soKyMoi = soKyHienTai + 1;
                
                await database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}`).update({
                    soKy: soKyMoi
                });

                alert('‚úÖ H·ªët h·ª•i th√†nh c√¥ng!');
                window.location.reload();

            } catch (error) {
                console.error('‚ùå L·ªói khi h·ªët h·ª•i:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi h·ªët h·ª•i: ' + error.message);
            }
        }

        // H·ªßy h·ªët h·ª•i
        function cancelHot() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy h·ªët h·ª•i kh√¥ng?')) {
                window.location.href = 'dashboard.html';
            }
        }

        // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa form
        function validateForm() {
            const kyHot = document.getElementById('kyHot').value;
            const nguoiHot = document.getElementById('nguoiHot').value;
            const ngayHot = document.getElementById('ngayHot').value;
            const gioHot = document.getElementById('gioHot').value;

            if (!kyHot || !nguoiHot || !ngayHot || !gioHot) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                return false;
            }

            // Ki·ªÉm tra k·ª≥ h·ªët c√≥ h·ª£p l·ªá kh√¥ng
            const soKyConLai = (currentHui.tongSoKy || 0) - (currentHui.soKy || 0);
            if (parseInt(kyHot) > soKyConLai) {
                alert('K·ª≥ h·ªët kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë k·ª≥ c√≤n l·∫°i!');
                return false;
            }

            return true;
        }

        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // ƒêƒÉng xu·∫•t
        function signOut() {
            auth.signOut().then(() => {
                window.location.href = 'dayhui.html';
            }).catch((error) => {
                console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
            });
        }

        // T·∫£i b·∫£ng danh s√°ch h·ªôi vi√™n
        async function loadMemberTable() {
    if (!currentHui || !currentHui.hoiVien) return;

    const tableHead = document.querySelector('#memberTable thead tr');
    const tableBody = document.getElementById('memberTableBody');

    while (tableHead.children.length > 3) {
        tableHead.removeChild(tableHead.lastChild);
    }
    tableBody.innerHTML = '';

    const hoiVienArray = getHoiVienArray()
        .filter(hv => hv && hv.ten && hv.soChan)
        .map((hv, i) => ({ ...hv, index: i + 1 }));

    const tongSoKy = currentHui.tongSoKy || 0;
    const soKyDaHot = currentHui.soKy || 0;
    const tienHui = currentHui.tienHui || 0;
    const tongHoiVien = hoiVienArray.length;

    // L·∫§Y DANH S√ÅCH THƒÇM K√äU THEO T·ª™NG K·ª≤
    const thamKeuTheoKy = {};
    try {
        const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot`);
        const hotSnap = await hotRef.once('value');
        if (hotSnap.exists()) {
            const listHot = hotSnap.val();
            for (const kyHot in listHot) {
                const hotData = listHot[kyHot];
                const normalizedData = normalizeHotData(hotData, kyHot);
                thamKeuTheoKy[parseInt(kyHot)] = normalizedData.thamKeu || 0;
            }
        }
    } catch (error) {
        console.error('‚ùå L·ªói khi l·∫•y thƒÉm k√™u theo k·ª≥:', error);
    }

    for (let i = 1; i <= tongSoKy; i++) {
        const th = document.createElement('th');
        th.className = 'period-col period-header';
        th.textContent = 'K·ª≥ ' + i;
        tableHead.appendChild(th);
    }

    // H√†ng thƒÉm k√™u
    const thamKeuRow = document.createElement('tr');
    thamKeuRow.className = 'tham-keu-row';

    const sttCell = document.createElement('td');
    sttCell.textContent = '';
    thamKeuRow.appendChild(sttCell);

    const nameCell = document.createElement('td');
    nameCell.textContent = 'ThƒÉm k√™u (s·ªë ti·ªÅn b·ªè)';
    nameCell.style.fontWeight = 'bold';
    thamKeuRow.appendChild(nameCell);

    const totalCell = document.createElement('td');
    totalCell.textContent = '';
    thamKeuRow.appendChild(totalCell);

    for (let i = 1; i <= tongSoKy; i++) {
        const cell = document.createElement('td');
        const thamKeuKyNay = thamKeuTheoKy[i] || (i <= soKyDaHot ? (currentHui.thamKeu || 0) : 0);
        cell.textContent = i <= soKyDaHot ? formatCurrency(thamKeuKyNay) : '';
        thamKeuRow.appendChild(cell);
    }
    tableBody.appendChild(thamKeuRow);

    // H√†ng ng∆∞·ªùi h·ªët & s·ªë ti·ªÅn nh·∫≠n
    const rowNguoiHot = document.createElement('tr');
    rowNguoiHot.className = 'tham-keu-row';

    const empty1 = document.createElement('td');
    empty1.textContent = '';
    rowNguoiHot.appendChild(empty1);

    const titleCell = document.createElement('td');
    titleCell.textContent = 'Ng∆∞·ªùi h·ªët & s·ªë ti·ªÅn nh·∫≠n';
    titleCell.style.fontWeight = 'bold';
    rowNguoiHot.appendChild(titleCell);

    const empty2 = document.createElement('td');
    empty2.textContent = '';
    rowNguoiHot.appendChild(empty2);

    for (let i = 1; i <= tongSoKy; i++) {
        const cell = document.createElement('td');
        const nguoiHot = hoiVienArray.find(hv => hv.daHot && hv.kyDaHot === i);

        if (nguoiHot) {
            const soChanSong = tongHoiVien - (i - 1);
            const soChanChet = i - 1;
            const thamKeuKyNay = thamKeuTheoKy[i] || (currentHui.thamKeu || 0);
            const tienNhan = (soChanSong * (tienHui - thamKeuKyNay)) + (soChanChet * tienHui) - currentHui.tienThao - (tienHui - thamKeuKyNay);
            
            cell.innerHTML = `<div><b>${nguoiHot.ten}</b></div>
                            <div class="text-success">${formatCurrency(tienNhan)}</div>
                            <small class="text-muted">L√£i/L·ªó: ${formatCurrency(((tienHui * (soChanSong - 1)) - ((soChanSong - 1) * (tienHui - thamKeuKyNay) - currentHui.tienThao)) * -1)}</small>`;
        } else {
            cell.textContent = i <= soKyDaHot ? 'Ch∆∞a h·ªët' : '-';
            cell.style.color = i <= soKyDaHot ? '#e74c3c' : '#999';
        }
        rowNguoiHot.appendChild(cell);
    }
    tableBody.appendChild(rowNguoiHot);

    // C√°c h√†ng h·ªôi vi√™n
    hoiVienArray.forEach((hoiVien, index) => {
        const row = document.createElement('tr');

        const sttCell = document.createElement('td');
        sttCell.textContent = index + 1;
        row.appendChild(sttCell);

        const nameCell = document.createElement('td');
        nameCell.className = 'name-col';
        nameCell.textContent = `${hoiVien.ten} (Ch√¢n ${hoiVien.soChan})`;
        if (hoiVien.daHot) {
            nameCell.innerHTML += ` <span class="badge bg-success">ƒê√£ h·ªët k·ª≥ ${hoiVien.kyDaHot}</span>`;
        }
        row.appendChild(nameCell);

        let tongTien = 0;
        const tienDongKy = [];

        for (let i = 1; i <= tongSoKy; i++) {
            let soTien = 0;
            let displayText = '';
            let cellClass = '';
            let isHotKy = false;

            const thamKeuKyNay = thamKeuTheoKy[i] || (i <= soKyDaHot ? (currentHui.thamKeu || 0) : 0);

            if (hoiVien.daHot && hoiVien.kyDaHot === i) {
                isHotKy = true;
                const soChanSong = tongHoiVien - (i - 1);
                const soChanChet = i - 1;
                soTien = (soChanSong * (tienHui - thamKeuKyNay)) + (soChanChet * tienHui) - currentHui.tienThao - (tienHui - thamKeuKyNay);
                tongTien += soTien;
                displayText = formatCurrency(soTien);
                cellClass = 'hot-amount';
            } else if (hoiVien.daDong && hoiVien.daDong[i]) {
                if (hoiVien.daHot && i > hoiVien.kyDaHot) {
                    soTien = tienHui;
                } else {
                    soTien = tienHui - thamKeuKyNay;
                }
                tongTien += soTien;
                displayText = formatCurrency(soTien);
                cellClass = 'paid-amount';
            } else {
                if (i <= soKyDaHot) {
                    if (hoiVien.daHot && i > hoiVien.kyDaHot) {
                        displayText = formatCurrency(tienHui);
                    } else {
                        displayText = formatCurrency(tienHui - thamKeuKyNay);
                    }
                    cellClass = 'not-paid';
                } else {
                    displayText = '';
                    cellClass = 'empty-cell';
                }
            }

            tienDongKy.push({
                ky: i,
                displayText: displayText,
                cellClass: cellClass,
                isHotKy: isHotKy,
                soTien: soTien
            });
        }

        const totalCell = document.createElement('td');
        totalCell.textContent = formatCurrency(tongTien);
        totalCell.className = 'total-col';
        row.appendChild(totalCell);

        tienDongKy.forEach(item => {
            const cell = document.createElement('td');
            cell.textContent = item.displayText;
            cell.className = item.cellClass;
            
            if (item.isHotKy) {
                cell.title = `H·ªët k·ª≥ ${item.ky} - Nh·∫≠n: ${item.displayText}`;
            }
            
            row.appendChild(cell);
        });

        tableBody.appendChild(row);
    });
}

        // Hi·ªÉn th·ªã modal th√¥ng tin d√¢y h·ª•i
        function showHuiInfoModal() {
            if (!currentHui) return;

            const huiInfoContent = document.getElementById('huiInfoContent');
            huiInfoContent.innerHTML = '';

            // T·∫°o n·ªôi dung modal
            const infoHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">T√™n d√¢y h·ª•i:</span>
                        <span class="info-value">${currentHui.tendayhui || 'Ch∆∞a ƒë·∫∑t t√™n'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ti·ªÅn h·ª•i:</span>
                        <span class="info-value">${formatCurrency(currentHui.tienHui || 0)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ti·ªÅn th·∫£o:</span>
                        <span class="info-value">${formatCurrency(currentHui.tienThao || 0)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">T·ªïng s·ªë k·ª≥:</span>
                        <span class="info-value">${currentHui.tongSoKy || 0} k·ª≥</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">S·ªë k·ª≥ ƒë√£ qua:</span>
                        <span class="info-value">${currentHui.soKy || 0} k·ª≥</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">S·ªë k·ª≥ c√≤n l·∫°i:</span>
                        <span class="info-value">${(currentHui.tongSoKy || 0) - (currentHui.soKy || 0)} k·ª≥</span>
                    </div>
                </div>

                <h5 class="mt-4">Danh s√°ch h·ªôi vi√™n</h5>
                <div class="table-responsive">
                    <table class="member-table-modal">
                        <thead>
                            <tr>
                                <th class="stt-col">STT</th>
                                <th class="name-col">H·ªôi vi√™n</th>
                                <th class="phone-col">S·ªë ƒëi·ªán tho·∫°i</th>
                                <th class="address-col">ƒê·ªãa ch·ªâ</th>
                                <th class="chan-col">S·ªë ch√¢n</th>
                                <th class="ky-col">K·ª≥ ƒë√£ h·ªët</th>
                                <th class="thamhot-col">ThƒÉm k√™u</th>
                                <th class="tiendong-col">Ti·ªÅn ƒë√≥ng</th>
                                <th class="tienhot-col">Ti·ªÅn h·ªët</th>
                            </tr>
                        </thead>
                        <tbody id="huiInfoMemberList">
                            <!-- Danh s√°ch h·ªôi vi√™n s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                        </tbody>
                    </table>
                </div>
            `;

            huiInfoContent.innerHTML = infoHTML;

            // T·∫£i danh s√°ch h·ªôi vi√™n cho modal
            loadHuiInfoMemberList();
        }

        // T·∫£i danh s√°ch h·ªôi vi√™n cho modal th√¥ng tin
        function loadHuiInfoMemberList() {
            if (!currentHui) return;

            const memberList = document.getElementById('huiInfoMemberList');
            memberList.innerHTML = '';

            // S·ª¨A L·∫†I: S·ª≠ d·ª•ng getHoiVienArray() ƒë·ªÉ l·∫•y danh s√°ch h·ªôi vi√™n ch√≠nh x√°c
            let hoiVienArray = getHoiVienArray();

            // T·∫£i l·ªãch s·ª≠ h·ªët h·ª•i
            const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot`);
            hotRef.once('value').then(snapshot => {
                const lichSuHot = snapshot.val() || {};

                hoiVienArray.forEach((hoiVien, index) => {
                    const row = document.createElement('tr');
                    
                    // STT
                    const sttCell = document.createElement('td');
                    sttCell.textContent = index + 1;
                    row.appendChild(sttCell);

                    // T√™n h·ªôi vi√™n
                    const nameCell = document.createElement('td');
                    nameCell.className = 'name-col';
                    nameCell.textContent = hoiVien.ten;
                    row.appendChild(nameCell);

                    // S·ªë ƒëi·ªán tho·∫°i
                    const phoneCell = document.createElement('td');
                    phoneCell.textContent = hoiVien.soDienThoai || '';
                    row.appendChild(phoneCell);

                    // ƒê·ªãa ch·ªâ
                    const addressCell = document.createElement('td');
                    addressCell.textContent = hoiVien.diaChi || '';
                    row.appendChild(addressCell);

                    // S·ªë ch√¢n
                    const chanCell = document.createElement('td');
                    chanCell.textContent = hoiVien.soChan || '';
                    row.appendChild(chanCell);

                    // K·ª≥ ƒë√£ h·ªët
                    const kyCell = document.createElement('td');
                    kyCell.textContent = hoiVien.kyDaHot || '';
                    row.appendChild(kyCell);

                    // ThƒÉm k√™u
                    const thamKeuCell = document.createElement('td');
                    thamKeuCell.textContent = hoiVien.thamKeu ? formatCurrency(hoiVien.thamKeu) : '';
                    row.appendChild(thamKeuCell);

                    // Ti·ªÅn ƒë√≥ng
                    const tienDongCell = document.createElement('td');
                    
                    // Ng∆∞·ªùi h·ªët th√¨ ti·ªÅn ƒë√≥ng = 0, c√°c h·ªôi vi√™n c√≤n l·∫°i = ti·ªÅn h·ª•i - thƒÉm k√™u
                    let tienDong = 0;
                    if (!hoiVien.daHot) {
                        tienDong = (currentHui.tienHui || 0) - (hoiVien.thamKeu || 0);
                    }
                    tienDongCell.textContent = formatCurrency(tienDong);
                    row.appendChild(tienDongCell);

                    // Ti·ªÅn h·ªët
                    const tienHotCell = document.createElement('td');
                    
                    // Ch·ªâ hi·ªÉn th·ªã ti·ªÅn h·ªët cho ng∆∞·ªùi ƒë√£ h·ªët
                    if (hoiVien.daHot && hoiVien.kyDaHot) {
                        const kyHot = hoiVien.kyDaHot;
                        const hotData = lichSuHot[kyHot];
                        if (hotData) {
                            const normalizedHotData = normalizeHotData(hotData, kyHot);
                            tienHotCell.textContent = formatCurrency(normalizedHotData.tongTienHot || 0);
                            tienHotCell.classList.add('hot-amount');
                        }
                    }
                    row.appendChild(tienHotCell);

                    memberList.appendChild(row);
                });
            });
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function() {
            if (initializeFirebase()) {
                checkAuthState();
            } else {
                console.error('‚ùå Kh√¥ng th·ªÉ kh·ªüi t·∫°o Firebase');
                alert('C√≥ l·ªói x·∫£y ra khi kh·ªüi t·∫°o ·ª©ng d·ª•ng. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }

            // Th√™m s·ª± ki·ªán cho modal th√¥ng tin d√¢y h·ª•i
            const huiInfoModal = document.getElementById('huiInfoModal');
            if (huiInfoModal) {
                huiInfoModal.addEventListener('show.bs.modal', showHuiInfoModal);
            }
        });
    </script>
</body>
</html>
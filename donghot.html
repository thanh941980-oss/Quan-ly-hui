<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê√≥ng H·ªët H·ª•i - Qu·∫£n L√Ω H·ª•i</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding: 20px;
        }
        
        .header {
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border: none;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .back-btn {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 20px;
            display: inline-block;
        }
        
        .back-btn:hover {
            text-decoration: underline;
        }
        
        .calculation-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .calculation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calculation-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary-color);
        }
        
        .loss {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .profit {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .member-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }
        
        .member-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .member-item:hover {
            background-color: #f8f9fa;
        }
        
        .member-item.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .member-item:last-child {
            border-bottom: none;
        }
        
        /* CSS cho b·∫£ng danh s√°ch h·ªôi vi√™n */
        .member-table-container {
            margin-top: 30px;
            overflow-x: auto;
        }
        
        .member-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .member-table th {
            background-color: var(--secondary-color);
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .member-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .member-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .member-table tr:hover {
            background-color: #e9ecef;
        }
        
        .member-table .stt-col {
            width: 50px;
        }
        
        .member-table .name-col {
            text-align: left;
            min-width: 150px;
        }
        
        .member-table .total-col {
            font-weight: bold;
            color: var(--primary-color);
            min-width: 120px;
        }
        
        .member-table .period-col {
            min-width: 100px;
        }
        
        .member-table .period-header {
            background-color: var(--primary-color);
        }
        
        .empty-cell {
            color: #aaa;
            font-style: italic;
        }
        
        .paid-amount {
            color: var(--success-color);
            font-weight: 500;
        }
        
        .not-paid {
            color: var(--accent-color);
            font-weight: 500;
        }
        
        .tham-keu-row {
            background-color: #f0f8ff !important;
            font-weight: 500;
        }
        
        .tham-keu-row td {
            border-bottom: 2px solid var(--primary-color);
        }
        
        .badge {
            font-size: 0.7em;
            margin-left: 5px;
        }
        
        .hot-amount {
            color: var(--primary-color);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="dashboard.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i Danh s√°ch d√¢y h·ª•i
        </a>
        
        <div class="header">
            <h2><i class="fas fa-money-bill-wave"></i> ƒê√≥ng H·ªët H·ª•i</h2>
            <div>
                <span class="me-3">Xin ch√†o, <span id="userEmail"></span></span>
                <button class="btn btn-outline-secondary" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                Th√¥ng tin h·ªët h·ª•i - <span id="huiNameDisplay">[T√™n d√¢y h·ª•i]</span>
            </div>
            <div class="card-body">
                <form id="hotHuiForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">K·ª≥ h·ªët h·ª•i *</label>
                                <input type="number" class="form-control" id="kyHot" 
                                       min="1" required placeholder="Nh·∫≠p k·ª≥ h·ªët" onchange="calculateTotals()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Ng√†y h·ªët *</label>
                                <input type="date" class="form-control" id="ngayHot" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Gi·ªù h·ªët *</label>
                                <input type="time" class="form-control" id="gioHot" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">ThƒÉm k√™u (s·ªë ti·ªÅn b·ªè) *</label>
                                <input type="number" class="form-control" id="thamKeu" 
                                       min="0" required value="0" onchange="calculateTotals()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Tr·ª´ ti·ªÅn kh√°c</label>
                                <input type="number" class="form-control" id="truTienKhac" 
                                       min="0" value="0" onchange="calculateTotals()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Ng∆∞·ªùi h·ªët *</label>
                                <select class="form-select" id="nguoiHot" required>
                                    <option value="">Ch·ªçn ng∆∞·ªùi h·ªët</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Th√¥ng tin d√¢y h·ª•i -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ti·ªÅn h·ª•i</label>
                                <input type="text" class="form-control" id="tienHuiDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ti·ªÅn th·∫£o</label>
                                <input type="text" class="form-control" id="tienThaoDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">S·ªë k·ª≥ c√≤n l·∫°i</label>
                                <input type="text" class="form-control" id="soKyConLaiDisplay" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">S·ªë ch√¢n</label>
                                <input type="text" class="form-control" id="soChanDisplay" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- T√≠nh to√°n -->
                    <div class="calculation-section">
                        <h5><i class="fas fa-calculator"></i> T√≠nh to√°n h·ªët h·ª•i</h5>
                        
                        <div class="calculation-item">
                            <span>S·ªë ch√¢n s·ªëng:</span>
                            <span id="soChanSongDisplay">0 ch√¢n</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>Ti·ªÅn h·ª•i sau th·∫£o:</span>
                            <span id="tienHuiSauThaoDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>S·ªë ch√¢n s·ªëng √ó Ti·ªÅn h·ª•i sau th·∫£o:</span>
                            <span id="chanSongTienHuiDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>S·ªë ch√¢n ch·∫øt:</span>
                            <span id="soChanChetDisplay">0 ch√¢n</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>S·ªë ch√¢n ch·∫øt √ó Ti·ªÅn h·ª•i:</span>
                            <span id="chanChetTienHuiDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>Tr·ª´ ti·ªÅn kh√°c:</span>
                            <span id="truTienKhacDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>T·ªïng s·ªë ti·ªÅn h·ªët:</span>
                            <span id="tongTienHotDisplay">0ƒë</span>
                        </div>
                        
                        <div class="calculation-item">
                            <span>L·ªùi/L·ªó:</span>
                            <span id="loiLoDisplay" class="profit">0ƒë</span>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="button" class="btn btn-success flex-fill" onclick="confirmHot()">
                            <i class="fas fa-check-circle"></i> X√°c nh·∫≠n h·ªët
                        </button>
                        <button type="button" class="btn btn-secondary flex-fill" onclick="cancelHot()">
                            <i class="fas fa-times-circle"></i> Hu·ª∑
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- B·∫£ng danh s√°ch h·ªôi vi√™n -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-users"></i> Danh s√°ch h·ªôi vi√™n v√† l·ªãch s·ª≠ ƒë√≥ng h·ª•i
            </div>
            <div class="card-body">
                <div class="member-table-container">
                    <table class="member-table" id="memberTable">
                        <thead>
                            <tr>
                                <th class="stt-col">STT</th>
                                <th class="name-col">H·ªôi vi√™n</th>
                                <th class="total-col">T·ªïng</th>
                                <!-- C√°c c·ªôt k·ª≥ s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông b·∫±ng JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                            <!-- D·ªØ li·ªáu h·ªôi vi√™n s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông b·∫±ng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyCYV8na-Az2LAgpl6QM2Tiwr6Gm9yhXQZ0",
    authDomain: "quan-ly-hui-8ad1c.firebaseapp.com",
    databaseURL: "https://quan-ly-hui-8ad1c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "quan-ly-hui-8ad1c",
    storageBucket: "quan-ly-hui-8ad1c.firebasestorage.app",
    messagingSenderId: "665511229865",
    appId: "1:665511229865:web:fe44f814fff618e35e6cb8"
};

let database;
let auth;
let currentUser = null;
let currentHui = null;
let currentHuiId = null;

// Kh·ªüi t·∫°o Firebase
function initializeFirebase() {
    try {
        if (typeof firebase === 'undefined') {
            throw new Error('Firebase SDK ch∆∞a ƒë∆∞·ª£c t·∫£i');
        }

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        database = firebase.database();
        auth = firebase.auth();
        console.log('‚úÖ Firebase ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng');
        return true;
    } catch (error) {
        console.error('‚ùå L·ªói kh·ªüi t·∫°o Firebase:', error);
        return false;
    }
}

// Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
function checkAuthState() {
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            console.log('‚úÖ Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p:', user.uid, user.email);
            document.getElementById('userEmail').textContent = user.email;
            loadHuiData();
        } else {
            currentUser = null;
            window.location.href = 'dayhui.html';
        }
    });
}

// L·∫•y d·ªØ li·ªáu d√¢y h·ª•i t·ª´ URL parameter
function getHuiIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('huiId');
}

// H√†m s·ª≠a l·ªói t·ª± ƒë·ªông t·∫•t c·∫£ c√°c tr∆∞·ªùng b·ªã sai
async function fixAllDataFieldNames() {
    try {
        const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot`);
        const snapshot = await hotRef.once('value');
        
        if (!snapshot.exists()) return;
        
        const updates = {};
        const listHot = snapshot.val();
        
        for (const kyHot in listHot) {
            const hot = listHot[kyHot];
            
            // Mapping c√°c tr∆∞·ªùng sai sang tr∆∞·ªùng ƒë√∫ng
            const fieldMappings = {
                'kyliot': 'kyHot',
                'lollo': 'loiLo', 
                'ngayliot': 'ngayHot',
                'nguolilot': 'nguoiHot',
                'nguolilotTen': 'nguoiHotTen',
                'nguoIHot': 'nguoiHot',
                'nguoIHotTen': 'nguoiHotTen',
                'thanKeu': 'thamKeu',
                'truTienKhao': 'truTienKhac'
            };
            
            for (const [wrongField, correctField] of Object.entries(fieldMappings)) {
                if (hot[wrongField] !== undefined && hot[wrongField] !== null) {
                    updates[`${kyHot}/${correctField}`] = hot[wrongField];
                    updates[`${kyHot}/${wrongField}`] = null; // X√≥a tr∆∞·ªùng sai
                }
            }
        }
        
        if (Object.keys(updates).length > 0) {
            await hotRef.update(updates);
            console.log('‚úÖ ƒê√£ s·ª≠a t·ª± ƒë·ªông t·∫•t c·∫£ c√°c t√™n tr∆∞·ªùng sai');
            return true;
        }
        return false;
    } catch (error) {
        console.error('‚ùå L·ªói khi s·ª≠a t√™n tr∆∞·ªùng:', error);
        return false;
    }
}

// H√†m chu·∫©n h√≥a d·ªØ li·ªáu h·ªët h·ª•i
function normalizeHotData(hotData, kyHot) {
    return {
        kyHot: hotData.kyHot || hotData.kyliot || parseInt(kyHot),
        nguoiHot: hotData.nguoiHot || hotData.nguolilot || hotData.nguoIHot || hotData.nguoHot,
        nguoiHotTen: hotData.nguoiHotTen || hotData.nguolilotTen || hotData.nguoIHotTen || hotData.nguoHotTen,
        thamKeu: hotData.thamKeu || hotData.thanKeu || hotData.thanKau || 0,
        ngayHot: hotData.ngayHot || hotData.ngayliot || new Date().toISOString().split('T')[0],
        gioHot: hotData.gioHot || '00:00',
        truTienKhac: hotData.truTienKhac || hotData.truTienKhao || hotData.truTienKhae || 0,
        tongTienHot: hotData.tongTienHot || 0,
        loiLo: hotData.loiLo || hotData.lollo || hotData.Ioilo || 0,
        ngayTao: hotData.ngayTao || new Date().toISOString()
    };
}

// T·∫£i d·ªØ li·ªáu d√¢y h·ª•i
async function loadHuiData() {
    const huiId = getHuiIdFromURL();
    if (!huiId) return;

    currentHuiId = huiId;

    try {
        const huiRef = database.ref('users/' + currentUser.uid + '/dayhui/' + huiId);
        const snapshot = await huiRef.once('value');
        if (!snapshot.exists()) return;

        currentHui = snapshot.val();

        // --- üîß T·ª± s·ª≠a l·ªói t√™n tr∆∞·ªùng sai n·∫øu c√≥ ---
        const hasFixed = await fixAllDataFieldNames();
        if (hasFixed) {
            console.log('üîÑ Reload d·ªØ li·ªáu sau khi s·ª≠a l·ªói...');
            const newSnapshot = await huiRef.once('value');
            currentHui = newSnapshot.val();
        }

        // --- ‚úÖ Chuy·ªÉn danh s√°ch h·ªôi vi√™n t·ª´ object v·ªÅ array n·∫øu c·∫ßn ---
        if (currentHui.hoiVien && !Array.isArray(currentHui.hoiVien)) {
            const tempHoiVien = [];
            Object.keys(currentHui.hoiVien).forEach(key => {
                tempHoiVien.push(currentHui.hoiVien[key]);
            });
            currentHui.hoiVien = tempHoiVien;
            console.log('üìã ƒê√£ chuy·ªÉn h·ªôi vi√™n t·ª´ object ‚Üí array');
        }

        // --- üßæ Load l·ªãch s·ª≠ h·ªët ---
        const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${huiId}/lichSuHot`);
        const hotSnap = await hotRef.once('value');

        if (hotSnap.exists()) {
            const listHot = hotSnap.val();
            const hoiVienArray = Array.isArray(currentHui.hoiVien)
                ? currentHui.hoiVien
                : [];

            for (const kyHot in listHot) {
                const rawHotData = listHot[kyHot];
                const hot = normalizeHotData(rawHotData, kyHot);

                const hoiVienId = hot.nguoiHot;
                if (!hoiVienId) {
                    console.warn('‚ö†Ô∏è Kh√¥ng c√≥ ID ng∆∞·ªùi h·ªët ·ªü k·ª≥', kyHot);
                    continue;
                }

                // --- üîç T√¨m h·ªôi vi√™n tr√πng ID ho·∫∑c tr√πng t√™n ---
                let hoiVien = hoiVienArray.find(hv => hv.id === hoiVienId);

                if (!hoiVien && hot.nguoiHotTen) {
                    hoiVien = hoiVienArray.find(hv => hv.ten === hot.nguoiHotTen.split(' ')[0]);
                }

                if (hoiVien) {
                    hoiVien.daHot = true;
                    hoiVien.kyDaHot = hot.kyHot;
                    hoiVien.ngayHot = hot.ngayHot;
                    console.log(`‚úÖ ${hoiVien.ten} ƒë√£ h·ªët k·ª≥ ${hot.kyHot}`);
                } else {
                    console.warn(`‚ùå Kh√¥ng t√¨m th·∫•y h·ªôi vi√™n c√≥ ID ${hoiVienId} ho·∫∑c t√™n ${hot.nguoiHotTen}`);
                }
            }
        } else {
            console.log('‚ÑπÔ∏è Ch∆∞a c√≥ l·ªãch s·ª≠ h·ªët h·ª•i.');
        }

        // --- Hi·ªÉn th·ªã th√¥ng tin v√† b·∫£ng ---
        displayHuiInfo();
        loadHoiVienList();
        setDefaultDateTime();
        loadMemberTable();

    } catch (error) {
        console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu d√¢y h·ª•i:', error);
    }
}

// Hi·ªÉn th·ªã th√¥ng tin d√¢y h·ª•i
function displayHuiInfo() {
    if (!currentHui) return;

    document.getElementById('huiNameDisplay').textContent = currentHui.tendayhui || 'Ch∆∞a c√≥ t√™n';
    document.getElementById('tienHuiDisplay').value = formatCurrency(currentHui.tienHui || 0);
    document.getElementById('tienThaoDisplay').value = formatCurrency(currentHui.tienThao || 0);
    
    const soKyConLai = (currentHui.tongSoKy || 0) - (currentHui.soKy || 0);
    document.getElementById('soKyConLaiDisplay').value = soKyConLai + ' k·ª≥';
    
    // S·ª¨A L·∫†I: S·ª≠ d·ª•ng getHoiVienArray() ƒë·ªÉ l·∫•y s·ªë ch√¢n ch√≠nh x√°c
    const soHoiVien = getHoiVienArray().length;
    document.getElementById('soChanDisplay').value = soHoiVien + ' ch√¢n';

    calculateTotals();
}

// T·∫£i danh s√°ch h·ªôi vi√™n
function loadHoiVienList() {
    if (!currentHui || !currentHui.hoiVien) return;

    const nguoiHotSelect = document.getElementById('nguoiHot');
    nguoiHotSelect.innerHTML = '<option value="">Ch·ªçn ng∆∞·ªùi h·ªët</option>';

    let hoiVienArray = getHoiVienArray();
    
    hoiVienArray.forEach(hoiVien => {
        if (hoiVien.trangThai === 'dang_tham_gia' && !hoiVien.daHot) {
            const option = document.createElement('option');
            option.value = hoiVien.id;
            option.textContent = hoiVien.ten + ' (Ch√¢n ' + hoiVien.soChan + ')';
            nguoiHotSelect.appendChild(option);
        }
    });
}

// H√†m l·∫•y danh s√°ch h·ªôi vi√™n d·∫°ng array
function getHoiVienArray() {
    if (!currentHui || !currentHui.hoiVien) return [];

    // L·∫•y ra danh s√°ch h·ªôi vi√™n (d√π l√† object hay array)
    let hoiVienArray = Array.isArray(currentHui.hoiVien)
        ? currentHui.hoiVien
        : Object.keys(currentHui.hoiVien).map(key => ({
            ...currentHui.hoiVien[key],
            id: key
        }));

    // L·ªçc b·ªè ph·∫ßn t·ª≠ kh√¥ng c√≥ t√™n
    hoiVienArray = hoiVienArray.filter(hv => hv && hv.ten);

    // üß© L·ªçc tr√πng ID ho·∫∑c tr√πng t√™n + s·ªë ch√¢n
    const unique = [];
    const seen = new Set();
    for (const hv of hoiVienArray) {
        const key = hv.id || `${hv.ten}_${hv.soChan}`;
        if (!seen.has(key)) {
            seen.add(key);
            unique.push(hv);
        }
    }

    console.log('üìä S·ªë h·ªôi vi√™n th·ª±c t·∫ø:', unique.length, unique);
    return unique;
}

// ƒê·∫∑t ng√†y gi·ªù m·∫∑c ƒë·ªãnh
function setDefaultDateTime() {
    const now = new Date();
    
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    document.getElementById('ngayHot').value = `${year}-${month}-${day}`;
    
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('gioHot').value = `${hours}:${minutes}`;
}

// T√≠nh to√°n t·ªïng ti·ªÅn
function calculateTotals() {
    if (!currentHui) return;

    const tienHui = currentHui.tienHui || 0;
    const tienThao = currentHui.tienThao || 0;
    const thamKeu = parseInt(document.getElementById('thamKeu').value) || 0;
    const truTienKhac = parseInt(document.getElementById('truTienKhac').value) || 0;
    const kyHot = parseInt(document.getElementById('kyHot').value) || 1;
    
    // S·ª¨A: S·ª≠ d·ª•ng getHoiVienArray() ƒë·ªÉ l·∫•y s·ªë ch√¢n ch√≠nh x√°c
    const soHoiVien = getHoiVienArray().length;
    const tongSoKy = currentHui.tongSoKy || 0;
    
    // T√çNH S·ªê CH√ÇN ƒê√öNG - d·ª±a tr√™n s·ªë h·ªôi vi√™n th·ª±c t·∫ø
    const soChanSong = soHoiVien - (kyHot - 1);  // S·ªë ch√¢n c√≤n s·ªëng = t·ªïng ch√¢n - s·ªë k·ª≥ ƒë√£ h·ªët
    const soChanChet = kyHot - 1;                 // S·ªë ch√¢n ƒë√£ ch·∫øt = s·ªë k·ª≥ ƒë√£ h·ªët

    console.log(`S·ªë ch√¢n th·ª±c t·∫ø: ${soHoiVien}, S·ªë ch√¢n s·ªëng: ${soChanSong}, S·ªë ch√¢n ch·∫øt: ${soChanChet}`);

    // C√îNG TH·ª®C T√çNH T·ªîNG TI·ªÄN H·ªêT (ƒê√öNG):
    const tongTienHot = (soChanSong * (tienHui - thamKeu)) + (soChanChet * tienHui) - tienThao - (tienHui - thamKeu)- truTienKhac;

    // C√îNG TH·ª®C T√çNH L√ÉI/L·ªñ (ƒê√öNG):
    
    const soKyConLai = tongSoKy - 1;
    const tongTienLyTuong = tienHui * soKyConLai;
    const loiLo = tongTienHot - tongTienLyTuong;

    // Hi·ªÉn th·ªã k·∫øt qu·∫£
    document.getElementById('soChanSongDisplay').textContent = soChanSong + ' ch√¢n';
    document.getElementById('tienHuiSauThaoDisplay').textContent = formatCurrency(tienHui - thamKeu);
    document.getElementById('chanSongTienHuiDisplay').textContent = formatCurrency(soChanSong * (tienHui - thamKeu));
    document.getElementById('soChanChetDisplay').textContent = soChanChet + ' ch√¢n';
    document.getElementById('chanChetTienHuiDisplay').textContent = formatCurrency(soChanChet * tienHui);
    document.getElementById('truTienKhacDisplay').textContent = formatCurrency(truTienKhac);
    document.getElementById('tongTienHotDisplay').textContent = formatCurrency(tongTienHot);
    
    const loiLoElement = document.getElementById('loiLoDisplay');
    loiLoElement.textContent = formatCurrency(loiLo);
    if (loiLo > 0) {
        loiLoElement.className = 'profit';
    } else if (loiLo < 0) {
        loiLoElement.className = 'loss';
    } else {
        loiLoElement.className = '';
    }
}

// T·∫£i v√† hi·ªÉn th·ªã b·∫£ng danh s√°ch h·ªôi vi√™n
async function loadMemberTable() {
    if (!currentHui || !currentHui.hoiVien) return;

    const tableHead = document.querySelector('#memberTable thead tr');
    const tableBody = document.getElementById('memberTableBody');

    while (tableHead.children.length > 3) {
        tableHead.removeChild(tableHead.lastChild);
    }
    tableBody.innerHTML = '';

    const hoiVienArray = getHoiVienArray()
        .filter(hv => hv && hv.ten && hv.soChan)
        .map((hv, i) => ({ ...hv, index: i + 1 }));

    const tongSoKy = currentHui.tongSoKy || 0;
    const soKyDaHot = currentHui.soKy || 0;
    const tienHui = currentHui.tienHui || 0;
    const tongHoiVien = hoiVienArray.length;

    // L·∫§Y DANH S√ÅCH THƒÇM K√äU THEO T·ª™NG K·ª≤
    const thamKeuTheoKy = {};
    try {
        const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot`);
        const hotSnap = await hotRef.once('value');
        if (hotSnap.exists()) {
            const listHot = hotSnap.val();
            for (const kyHot in listHot) {
                const hotData = listHot[kyHot];
                const normalizedData = normalizeHotData(hotData, kyHot);
                thamKeuTheoKy[parseInt(kyHot)] = normalizedData.thamKeu || 0;
            }
        }
    } catch (error) {
        console.error('‚ùå L·ªói khi l·∫•y thƒÉm k√™u theo k·ª≥:', error);
    }

    for (let i = 1; i <= tongSoKy; i++) {
        const th = document.createElement('th');
        th.className = 'period-col period-header';
        th.textContent = 'K·ª≥ ' + i;
        tableHead.appendChild(th);
    }

    // H√†ng thƒÉm k√™u
    const thamKeuRow = document.createElement('tr');
    thamKeuRow.className = 'tham-keu-row';

    const sttCell = document.createElement('td');
    sttCell.textContent = '';
    thamKeuRow.appendChild(sttCell);

    const nameCell = document.createElement('td');
    nameCell.textContent = 'ThƒÉm k√™u (s·ªë ti·ªÅn b·ªè)';
    nameCell.style.fontWeight = 'bold';
    thamKeuRow.appendChild(nameCell);

    const totalCell = document.createElement('td');
    totalCell.textContent = '';
    thamKeuRow.appendChild(totalCell);

    for (let i = 1; i <= tongSoKy; i++) {
        const cell = document.createElement('td');
        const thamKeuKyNay = thamKeuTheoKy[i] || (i <= soKyDaHot ? (currentHui.thamKeu || 0) : 0);
        cell.textContent = i <= soKyDaHot ? formatCurrency(thamKeuKyNay) : '';
        thamKeuRow.appendChild(cell);
    }
    tableBody.appendChild(thamKeuRow);

    // H√†ng ng∆∞·ªùi h·ªët & s·ªë ti·ªÅn nh·∫≠n
    const rowNguoiHot = document.createElement('tr');
    rowNguoiHot.className = 'tham-keu-row';

    const empty1 = document.createElement('td');
    empty1.textContent = '';
    rowNguoiHot.appendChild(empty1);

    const titleCell = document.createElement('td');
    titleCell.textContent = 'Ng∆∞·ªùi h·ªët & s·ªë ti·ªÅn nh·∫≠n';
    titleCell.style.fontWeight = 'bold';
    rowNguoiHot.appendChild(titleCell);

    const empty2 = document.createElement('td');
    empty2.textContent = '';
    rowNguoiHot.appendChild(empty2);

    for (let i = 1; i <= tongSoKy; i++) {
        const cell = document.createElement('td');
        const nguoiHot = hoiVienArray.find(hv => hv.daHot && hv.kyDaHot === i);

        if (nguoiHot) {
            const soChanSong = tongHoiVien - (i - 1);
            const soChanChet = i - 1;
            const thamKeuKyNay = thamKeuTheoKy[i] || (currentHui.thamKeu || 0);
            const tienNhan = (soChanSong * (tienHui - thamKeuKyNay)) + (soChanChet * tienHui) - currentHui.tienThao - (tienHui - thamKeuKyNay);
            
            cell.innerHTML = `<div><b>${nguoiHot.ten}</b></div>
                            <div class="text-success">${formatCurrency(tienNhan)}</div>
                            <small class="text-muted">L√£i/L·ªó: ${formatCurrency(((tienHui * (soChanSong - 1)) - ((soChanSong - 1) * (tienHui - thamKeuKyNay) - currentHui.tienThao)) * -1)}</small>`;
        } else {
            cell.textContent = i <= soKyDaHot ? 'Ch∆∞a h·ªët' : '-';
            cell.style.color = i <= soKyDaHot ? '#e74c3c' : '#999';
        }
        rowNguoiHot.appendChild(cell);
    }
    tableBody.appendChild(rowNguoiHot);

    // C√°c h√†ng h·ªôi vi√™n
    hoiVienArray.forEach((hoiVien, index) => {
        const row = document.createElement('tr');

        const sttCell = document.createElement('td');
        sttCell.textContent = index + 1;
        row.appendChild(sttCell);

        const nameCell = document.createElement('td');
        nameCell.className = 'name-col';
        nameCell.textContent = `${hoiVien.ten} (Ch√¢n ${hoiVien.soChan})`;
        if (hoiVien.daHot) {
            nameCell.innerHTML += ` <span class="badge bg-success">ƒê√£ h·ªët k·ª≥ ${hoiVien.kyDaHot}</span>`;
        }
        row.appendChild(nameCell);

        let tongTien = 0;
        const tienDongKy = [];

        for (let i = 1; i <= tongSoKy; i++) {
            let soTien = 0;
            let displayText = '';
            let cellClass = '';
            let isHotKy = false;

            const thamKeuKyNay = thamKeuTheoKy[i] || (i <= soKyDaHot ? (currentHui.thamKeu || 0) : 0);

            if (hoiVien.daHot && hoiVien.kyDaHot === i) {
                isHotKy = true;
                const soChanSong = tongHoiVien - (i - 1);
                const soChanChet = i - 1;
                soTien = (soChanSong * (tienHui - thamKeuKyNay)) + (soChanChet * tienHui) - currentHui.tienThao - (tienHui - thamKeuKyNay);
                tongTien += soTien;
                displayText = formatCurrency(soTien);
                cellClass = 'hot-amount';
            } else if (hoiVien.daDong && hoiVien.daDong[i]) {
                if (hoiVien.daHot && i > hoiVien.kyDaHot) {
                    soTien = tienHui;
                } else {
                    soTien = tienHui - thamKeuKyNay;
                }
                tongTien += soTien;
                displayText = formatCurrency(soTien);
                cellClass = 'paid-amount';
            } else {
                if (i <= soKyDaHot) {
                    if (hoiVien.daHot && i > hoiVien.kyDaHot) {
                        displayText = formatCurrency(tienHui);
                    } else {
                        displayText = formatCurrency(tienHui - thamKeuKyNay);
                    }
                    cellClass = 'not-paid';
                } else {
                    displayText = '';
                    cellClass = 'empty-cell';
                }
            }

            tienDongKy.push({
                ky: i,
                displayText: displayText,
                cellClass: cellClass,
                isHotKy: isHotKy,
                soTien: soTien
            });
        }

        const totalCell = document.createElement('td');
        totalCell.textContent = formatCurrency(tongTien);
        totalCell.className = 'total-col';
        row.appendChild(totalCell);

        tienDongKy.forEach(item => {
            const cell = document.createElement('td');
            cell.textContent = item.displayText;
            cell.className = item.cellClass;
            
            if (item.isHotKy) {
                cell.title = `H·ªët k·ª≥ ${item.ky} - Nh·∫≠n: ${item.displayText}`;
            }
            
            row.appendChild(cell);
        });

        tableBody.appendChild(row);
    });
}

// ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { 
        style: 'currency', 
        currency: 'VND' 
    }).format(amount);
}

// X√°c nh·∫≠n h·ªët
async function confirmHot() {
    if (!validateForm()) return;

    const kyHot = parseInt(document.getElementById('kyHot').value);
    const nguoiHotId = document.getElementById('nguoiHot').value;
    const nguoiHotTen = document.getElementById('nguoiHot').options[
        document.getElementById('nguoiHot').selectedIndex
    ].text;
    const thamKeu = parseInt(document.getElementById('thamKeu').value);
    const ngayHot = document.getElementById('ngayHot').value;
    const gioHot = document.getElementById('gioHot').value;
    const truTienKhac = parseInt(document.getElementById('truTienKhac').value) || 0;
    const tongTienHot = parseInt(document.getElementById('tongTienHotDisplay').textContent.replace(/[^\d]/g, '')) || 0;
    const loiLo = parseInt(document.getElementById('loiLoDisplay').textContent.replace(/[^\d]/g, '')) || 0;

    const hotData = {
        kyHot,
        nguoiHot: nguoiHotId,
        nguoiHotTen,
        thamKeu,
        ngayHot,
        gioHot,
        truTienKhac,
        tongTienHot,
        loiLo,
        ngayTao: new Date().toISOString()
    };

    try {
        const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot/${kyHot}`);
        await hotRef.set(hotData);

        const huiRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}`);
        await huiRef.transaction((currentData) => {
            if (currentData) {
                currentData.soKy = (currentData.soKy || 0) + 1;
                currentData.thamKeu = thamKeu;
            }
            return currentData;
        });

        await updateHoiVienHotHui(nguoiHotId, kyHot);

        console.log(`‚úÖ ƒê√£ l∆∞u th√¥ng tin h·ªët h·ª•i k·ª≥ ${kyHot} th√†nh c√¥ng.`);
        alert(`ƒê√£ x√°c nh·∫≠n h·ªët h·ª•i k·ª≥ ${kyHot} th√†nh c√¥ng!`);
        
        setTimeout(() => {
            loadHuiData();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå L·ªói khi l∆∞u th√¥ng tin h·ªët:', error);
        alert('L·ªói khi l∆∞u th√¥ng tin: ' + error.message);
    }
    // Trong h√†m confirmHot() c·ªßa donghot.html, th√™m sau khi h·ªët th√†nh c√¥ng
    await updateHuiStatus(currentHuiId); // C·∫≠p nh·∫≠t tr·∫°ng th√°i d√¢y h·ª•i
}

// C·∫≠p nh·∫≠t h·ªôi vi√™n h·ªët h·ª•i
async function updateHoiVienHotHui(hoiVienId, kyHot) {
    if (!currentHui || !currentHui.hoiVien) return;

    try {
        const hoiVienPath = `users/${currentUser.uid}/dayhui/${currentHuiId}/hoiVien/${hoiVienId}`;
        const hoiVienRef = database.ref(hoiVienPath);

        await hoiVienRef.update({
            daHot: true,
            kyDaHot: kyHot,
            ngayHot: new Date().toISOString()
        });

        console.log(`‚úÖ ƒê√£ ƒë√°nh d·∫•u h·ªôi vi√™n ${hoiVienId} ƒë√£ h·ªët k·ª≥ ${kyHot}`);

        await markAllMembersPaidForCurrentPeriod(kyHot);

    } catch (error) {
        console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t h·ªôi vi√™n h·ªët:', error);
        throw error;
    }
}

// ƒê√°nh d·∫•u t·∫•t c·∫£ h·ªôi vi√™n ƒë√£ ƒë√≥ng ti·ªÅn cho k·ª≥ h·ªët
async function markAllMembersPaidForCurrentPeriod(kyHot) {
    if (!currentHui || !currentHui.hoiVien) return;

    try {
        const hoiVienArray = getHoiVienArray();
        const updatePromises = [];

        for (const hoiVien of hoiVienArray) {
            if (!hoiVien.daHot && hoiVien.trangThai === 'dang_tham_gia') {
                const hoiVienPath = 'users/' + currentUser.uid + '/dayhui/' + currentHuiId + '/hoiVien/' + hoiVien.id;
                const hoiVienRef = database.ref(hoiVienPath);
                
                updatePromises.push(
                    hoiVienRef.update({
                        [`daDong/${kyHot}`]: true
                    })
                );
            }
        }

        await Promise.all(updatePromises);
        console.log('‚úÖ ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ h·ªôi vi√™n ƒë√£ ƒë√≥ng cho k·ª≥', kyHot);

    } catch (error) {
        console.error('‚ùå L·ªói khi ƒë√°nh d·∫•u h·ªôi vi√™n ƒë√£ ƒë√≥ng:', error);
        throw error;
    }
}

// Validate form
function validateForm() {
    const kyHot = document.getElementById('kyHot').value;
    const nguoiHot = document.getElementById('nguoiHot').value;
    const ngayHot = document.getElementById('ngayHot').value;
    const gioHot = document.getElementById('gioHot').value;
    const thamKeu = document.getElementById('thamKeu').value;

    if (!kyHot || !nguoiHot || !ngayHot || !gioHot || !thamKeu) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (*)');
        return false;
    }

    if (parseInt(kyHot) <= (currentHui.soKy || 0)) {
        alert('K·ª≥ h·ªët ph·∫£i l·ªõn h∆°n k·ª≥ hi·ªán t·∫°i (' + (currentHui.soKy || 0) + ')');
        return false;
    }

    return true;
}

// Hu·ª∑ h·ªët
function cancelHot() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën hu·ª∑? Th√¥ng tin ƒë√£ nh·∫≠p s·∫Ω b·ªã m·∫•t.')) {
        window.location.href = 'dayhui.html';
    }
}
// H√†m s·ª≠a l·ªói t·ª± ƒë·ªông t·∫•t c·∫£ c√°c tr∆∞·ªùng b·ªã sai
async function fixAllDataFieldNames() {
    try {
        const hotRef = database.ref(`users/${currentUser.uid}/dayhui/${currentHuiId}/lichSuHot`);
        const snapshot = await hotRef.once('value');
        
        if (!snapshot.exists()) return;
        
        const updates = {};
        const listHot = snapshot.val();
        
        for (const kyHot in listHot) {
            const hot = listHot[kyHot];
            
            // Mapping c√°c tr∆∞·ªùng sai sang tr∆∞·ªùng ƒë√∫ng - TH√äM C√ÅC TR∆Ø·ªúNG M·ªöI
            const fieldMappings = {
                'kyliot': 'kyHot',
                'lollo': 'loiLo', 
                'ngayliot': 'ngayHot',
                'nguolilot': 'nguoiHot',
                'nguolilotTen': 'nguoiHotTen',
                'nguoIHot': 'nguoiHot',
                'nguoIHotTen': 'nguoiHotTen',
                'thanKeu': 'thamKeu',
                'truTienKhao': 'truTienKhac',
                // TH√äM C√ÅC TR∆Ø·ªúNG M·ªöI PH√ÅT HI·ªÜN T·ª™ ·∫¢NH
                'nguoHot': 'nguoiHot',
                'nguoHotTen': 'nguoiHotTen', 
                'thanKau': 'thamKeu',
                'truTienKhae': 'truTienKhac',
                'Ioilo': 'loiLo'
            };
            
            for (const [wrongField, correctField] of Object.entries(fieldMappings)) {
                if (hot[wrongField] !== undefined && hot[wrongField] !== null) {
                    updates[`${kyHot}/${correctField}`] = hot[wrongField];
                    updates[`${kyHot}/${wrongField}`] = null; // X√≥a tr∆∞·ªùng sai
                }
            }
        }
        
        if (Object.keys(updates).length > 0) {
            await hotRef.update(updates);
            console.log('‚úÖ ƒê√£ s·ª≠a t·ª± ƒë·ªông t·∫•t c·∫£ c√°c t√™n tr∆∞·ªùng sai');
            return true;
        }
        return false;
    } catch (error) {
        console.error('‚ùå L·ªói khi s·ª≠a t√™n tr∆∞·ªùng:', error);
        return false;
    }
}

// ƒêƒÉng xu·∫•t
function signOut() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
        auth.signOut();
    }
}

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
document.addEventListener('DOMContentLoaded', function() {
    if (initializeFirebase()) {
        checkAuthState();
    }
});
    </script>
</body>
</html>